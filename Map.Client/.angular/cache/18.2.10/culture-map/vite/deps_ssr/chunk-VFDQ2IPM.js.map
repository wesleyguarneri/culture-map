{
  "version": 3,
  "sources": ["../../../../../../node_modules/@arcgis/core/views/interactive/snapping/SnappingDragPipelineStep.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport { abortMaybe as n, removeMaybe as e } from \"../../../core/maybe.js\";\nimport { ignoreAbortErrors as t, debounce as o } from \"../../../core/promiseUtils.js\";\nimport { watch as r } from \"../../../core/reactiveUtils.js\";\nimport { pointEquals as i } from \"../../../layers/graphics/dehydratedFeatureComparison.js\";\nimport { clonePoint as l } from \"../../../layers/graphics/hydratedFeatures.js\";\nimport { absoluteHeightElevationInfo as a } from \"../../../support/elevationInfoUtils.js\";\nimport { EventPipeline as s } from \"../dragEventPipeline.js\";\nimport { SnappingContext as u } from \"./SnappingContext.js\";\nimport { TaskPriority as c, ImmediateTask as p } from \"../../support/Scheduler.js\";\nfunction f({\n  predicate: o = () => !0,\n  snappingManager: i,\n  snappingContext: l,\n  updatingHandles: u,\n  useZ: c = !0\n}) {\n  const p = new s();\n  if (null == i) return {\n    snappingStep: [y, p],\n    cancelSnapping: y\n  };\n  let f,\n    Z = null,\n    j = null,\n    z = null;\n  const T = () => {\n      Z = n(Z), i.doneSnapping(), j?.frameTask.remove(), j = null, f = e(f), z = null;\n    },\n    k = d(i, c, p);\n  let w = null,\n    I = null,\n    U = null;\n  return {\n    snappingStep: [n => {\n      if (!o(n)) return n;\n      const {\n        action: e\n      } = n;\n      if (\"start\" === e) {\n        const {\n            info: e\n          } = n,\n          t = m(i.view);\n        if (j = g(l, n, t), j.context.selfSnappingZ = null, !c && null != e) {\n          const n = S(l.coordinateHelper, e.handle.component);\n          null != n && (j.context.selfSnappingZ = {\n            value: n,\n            elevationInfo: l.elevationInfo ?? a\n          });\n        }\n      }\n      if (null != j) {\n        const {\n            context: o,\n            originalScenePos: l,\n            originalPos: a\n          } = j,\n          {\n            mapEnd: s,\n            mapStart: p,\n            scenePoints: d\n          } = n,\n          m = x(a, v(s, p)),\n          g = v(p, a),\n          S = {\n            ...n,\n            action: \"update\"\n          },\n          y = j.context,\n          T = P(l, d),\n          C = i.update({\n            point: m,\n            scenePoint: T,\n            context: o\n          });\n        if (U = C, h(s, C, g, c), w = m, I = T, \"end\" !== e) {\n          const {\n            frameTask: n\n          } = j;\n          null == Z && (Z = new AbortController()), z = e => {\n            u.addPromise(t(k({\n              frameTask: n,\n              event: S,\n              context: y,\n              point: m,\n              scenePoint: T,\n              delta: g,\n              getLastState: () => ({\n                point: w,\n                scenePoint: I,\n                updatePoint: e.forceUpdate ? null : U\n              })\n            }, Z.signal)));\n          }, z({\n            forceUpdate: !1\n          }), null == f && (f = r(() => i.options.effectiveEnabled, () => z?.({\n            forceUpdate: !0\n          })));\n        }\n      }\n      return \"end\" === e && T(), n;\n    }, p],\n    cancelSnapping: n => (T(), n)\n  };\n}\nfunction d(n, e, t) {\n  return o(async ({\n    frameTask: o,\n    point: r,\n    scenePoint: l,\n    context: a,\n    event: s,\n    delta: u,\n    getLastState: c\n  }, p) => {\n    const f = await o.schedule(() => n.snap({\n      point: r,\n      scenePoint: l,\n      context: a,\n      signal: p\n    }), p);\n    if (f.valid) {\n      let l = await o.schedule(() => f.apply(), p);\n      const d = c();\n      null != d.point && r !== d.point && (l = n.update({\n        point: d.point,\n        scenePoint: d.scenePoint,\n        context: a\n      })), null != d.updatePoint && i(l, d.updatePoint) || (h(s.mapEnd, l, u, e), t.execute(s));\n    }\n  });\n}\nfunction m(n) {\n  return \"3d\" === n.type ? n.resourceController.scheduler.registerTask(c.SNAPPING) : p;\n}\nfunction g(n, e, t) {\n  return {\n    context: new u({\n      editGeometryOperations: n.editGeometryOperations,\n      elevationInfo: n.elevationInfo,\n      pointer: n.pointer,\n      vertexHandle: null != e.info ? e.info.handle : null,\n      excludeFeature: n.excludeFeature,\n      feature: n.feature,\n      visualizer: n.visualizer\n    }),\n    originalPos: null != e.snapOrigin ? n.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin) : e.mapStart,\n    originalScenePos: null != e.scenePoints ? e.scenePoints.sceneStart : null,\n    frameTask: t\n  };\n}\nfunction x(n, [e, t, o]) {\n  const r = l(n);\n  return r.x += e, r.y += t, r.hasZ && (r.z += o), r;\n}\nfunction P(n, e) {\n  return null == n || null == e ? null : x(n, v(e.sceneEnd, e.sceneStart));\n}\nfunction v(n, e) {\n  const t = n.hasZ && e.hasZ ? n.z - e.z : 0;\n  return [n.x - e.x, n.y - e.y, t];\n}\nfunction h(n, e, [t, o, r], i) {\n  n.x = e.x + t, n.y = e.y + o, i && n.hasZ && e.hasZ && (n.z = e.z + r);\n}\nfunction S(n, e) {\n  if (!n.hasZ()) return null;\n  const t = e.vertices;\n  let o = null;\n  for (const r of t) {\n    const e = n.getZ(r.pos);\n    if (null != o && null != e && Math.abs(e - o) > 1e-6) return null;\n    null == o && (o = e);\n  }\n  return o;\n}\nfunction y(n) {\n  return n;\n}\nexport { f as createSnapDragEventPipelineStep };"],
  "mappings": "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",
  "names": ["l", "f", "j", "k", "d", "w", "I", "e", "n", "o", "a", "p", "m", "x", "g", "S", "y", "T"]
}
