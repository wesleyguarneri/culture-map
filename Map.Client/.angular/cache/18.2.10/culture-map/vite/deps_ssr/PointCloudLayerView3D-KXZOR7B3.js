import { createRequire } from 'module';const require = createRequire(import.meta.url);
import {
  L
} from "./chunk-YFBJMO7M.js";
import {
  O as O5,
  P as P3,
  _ as _4,
  j as j2
} from "./chunk-P2CNJAJT.js";
import {
  i as i5
} from "./chunk-6JE54UIZ.js";
import "./chunk-W255B427.js";
import {
  A as A2
} from "./chunk-BWEUXIU7.js";
import {
  s as s4
} from "./chunk-D7KGWTOO.js";
import {
  m
} from "./chunk-2RZQMCBM.js";
import "./chunk-PDKNFFCG.js";
import "./chunk-INUNNFZT.js";
import "./chunk-NF2MOJH5.js";
import "./chunk-BKOZEXTL.js";
import {
  r as r7
} from "./chunk-NLRSH3TD.js";
import {
  c as c4
} from "./chunk-3Q4YEFJ3.js";
import {
  G,
  e as e7,
  i as i4
} from "./chunk-K6JW77RY.js";
import "./chunk-377KSYNB.js";
import {
  t as t8
} from "./chunk-J53R4G62.js";
import {
  t as t7
} from "./chunk-R7WTJU3N.js";
import {
  l as l2
} from "./chunk-ECUSUVZM.js";
import "./chunk-CQIKG7VH.js";
import "./chunk-3ILFY654.js";
import {
  y as y3
} from "./chunk-CXYUBZAK.js";
import {
  c as c3
} from "./chunk-LUORW76W.js";
import "./chunk-ZCCDVQ3H.js";
import "./chunk-N4FQBAT2.js";
import {
  r as r3
} from "./chunk-3FFTEL3W.js";
import {
  E as E3
} from "./chunk-4WON4QDF.js";
import {
  e as e6,
  f as f2
} from "./chunk-Q5PBA64J.js";
import {
  t as t6
} from "./chunk-TIAWSZQK.js";
import {
  r as r4,
  r2 as r5,
  t as t5
} from "./chunk-22UDIQGJ.js";
import "./chunk-6YHZYHJS.js";
import "./chunk-I47GCEJP.js";
import {
  r as r6
} from "./chunk-LA4GCRJY.js";
import "./chunk-W24M6HII.js";
import {
  O as O4
} from "./chunk-E5RXQH35.js";
import "./chunk-4U7LUZFD.js";
import "./chunk-T257OY4U.js";
import "./chunk-BMO2W6EC.js";
import "./chunk-QA265FYQ.js";
import {
  S,
  _ as _3,
  o as o2
} from "./chunk-HUOFTIIK.js";
import "./chunk-4J7E4E75.js";
import "./chunk-3NWWTJOW.js";
import "./chunk-TRF6JO5N.js";
import "./chunk-ZHVMMFTW.js";
import {
  h as h2
} from "./chunk-C7GHK6X7.js";
import {
  t as t4
} from "./chunk-EPIUUGS2.js";
import "./chunk-SNHVHW2N.js";
import {
  c
} from "./chunk-MDEPINSI.js";
import "./chunk-7Z4UWMRU.js";
import {
  a as a4,
  c as c2,
  u as u3
} from "./chunk-I75KW3AP.js";
import {
  t as t3
} from "./chunk-YEB36ZCF.js";
import "./chunk-MTXTLDZX.js";
import "./chunk-LCPLUSDH.js";
import {
  t as t2
} from "./chunk-KINQ7OJ3.js";
import {
  C as C2,
  E as E2,
  F,
  O as O3,
  f
} from "./chunk-KYLW5XXS.js";
import "./chunk-B76NC7GX.js";
import "./chunk-HFXXFWYN.js";
import {
  I as I2,
  i as i3
} from "./chunk-EXKCGLRO.js";
import "./chunk-WRLGLGM6.js";
import "./chunk-47DYJR3W.js";
import "./chunk-QRWQ6QBB.js";
import "./chunk-VENH3UKS.js";
import {
  h
} from "./chunk-ZSJNH2BT.js";
import "./chunk-OOK3QTWF.js";
import "./chunk-VFYCIIDC.js";
import {
  ae,
  se
} from "./chunk-ZWAQV54Z.js";
import "./chunk-5PXOWPHT.js";
import "./chunk-OGKROLZ3.js";
import "./chunk-BHG37GSO.js";
import "./chunk-QI5HKZYN.js";
import "./chunk-RIZOHDTP.js";
import "./chunk-ZFES27RA.js";
import "./chunk-XP2AJZUL.js";
import "./chunk-CZA7RDJP.js";
import "./chunk-FYE6XHDR.js";
import "./chunk-NCMX3DAD.js";
import "./chunk-BCNABTAE.js";
import "./chunk-3PPEJ4QJ.js";
import "./chunk-ZEOLGKXL.js";
import {
  g as g3,
  o
} from "./chunk-HITI6WDM.js";
import "./chunk-IS4RJOPJ.js";
import "./chunk-XK3CKE5Q.js";
import "./chunk-AMH7CZMY.js";
import "./chunk-EAVSYZXD.js";
import "./chunk-7GHUVMBI.js";
import "./chunk-Q5JLNMWZ.js";
import "./chunk-AABDXAD3.js";
import "./chunk-LGS63R4F.js";
import "./chunk-L6FG3WIC.js";
import {
  k
} from "./chunk-6ZLH7XBS.js";
import "./chunk-44ZUWZXU.js";
import "./chunk-7QOUHKW5.js";
import "./chunk-NHYYZMJR.js";
import "./chunk-U4EMQMDC.js";
import "./chunk-WVSTX2NW.js";
import "./chunk-MKFGPBQ3.js";
import {
  I
} from "./chunk-AVCKPV77.js";
import "./chunk-MNBTLVRM.js";
import "./chunk-GNCXYHNE.js";
import "./chunk-CSK4VZQ7.js";
import {
  E,
  _ as _2
} from "./chunk-2TNGEJGS.js";
import "./chunk-OYGNGIHQ.js";
import "./chunk-GSG4T2KM.js";
import {
  e as e5
} from "./chunk-D7C26LZP.js";
import "./chunk-BZHHBBFX.js";
import "./chunk-GK5M6FUR.js";
import "./chunk-MRP3FBLV.js";
import {
  a as a3
} from "./chunk-Y7SJWJAL.js";
import "./chunk-A2FDYA6M.js";
import "./chunk-YGAXDKHF.js";
import "./chunk-4TOSJLKR.js";
import "./chunk-ORYC4PVJ.js";
import "./chunk-DXIKKLD7.js";
import "./chunk-VQNXE43R.js";
import {
  i,
  p
} from "./chunk-VZ37C3ID.js";
import "./chunk-Q5TIVVER.js";
import {
  d as d2
} from "./chunk-NVOJILW6.js";
import "./chunk-KYPTWEOO.js";
import "./chunk-WVFB3H4O.js";
import "./chunk-C7BQE556.js";
import "./chunk-ZREJ3Y2F.js";
import "./chunk-IR6CVPPC.js";
import "./chunk-BBUQOCRA.js";
import "./chunk-YBUJLIWZ.js";
import "./chunk-DL2B6IFJ.js";
import {
  B,
  O as O2,
  Y,
  b as b2,
  i as i2,
  v as v2,
  y as y2,
  z
} from "./chunk-VOOO6FU5.js";
import "./chunk-IUPJR3FF.js";
import "./chunk-TGZW6QWO.js";
import "./chunk-OYIDHTXG.js";
import "./chunk-KUBMHTYA.js";
import "./chunk-VSQZQLTQ.js";
import {
  s as s3
} from "./chunk-K43CZ3M5.js";
import "./chunk-6EIBUVMG.js";
import "./chunk-NXXQ35YM.js";
import "./chunk-LM3JDV4W.js";
import "./chunk-34V2CLL5.js";
import "./chunk-CXNERL22.js";
import "./chunk-7V4JSBFA.js";
import "./chunk-2EJFYNM7.js";
import "./chunk-DC5LRNPY.js";
import "./chunk-ASCK5HJ5.js";
import "./chunk-5X5U7R6O.js";
import "./chunk-XNLAOXPY.js";
import "./chunk-C2OXE4NQ.js";
import "./chunk-KOI252FF.js";
import {
  x
} from "./chunk-I2TVVMQ6.js";
import "./chunk-5EGQYY2H.js";
import "./chunk-JKPUNUQA.js";
import "./chunk-SR7PRON4.js";
import "./chunk-HGHPYGKP.js";
import "./chunk-4DSGTDZJ.js";
import {
  u as u2
} from "./chunk-VYTPFEL2.js";
import "./chunk-RLGDH6IY.js";
import "./chunk-MRPCXIVS.js";
import "./chunk-YTKVV2Y3.js";
import "./chunk-GCVQXAS4.js";
import "./chunk-UFQD6AL4.js";
import "./chunk-THZPD5CT.js";
import "./chunk-OBCA6CWH.js";
import "./chunk-2JI245BP.js";
import "./chunk-N34BRXVM.js";
import "./chunk-7QV7DHWN.js";
import "./chunk-4L4Y34YK.js";
import "./chunk-BXONKQKI.js";
import "./chunk-2HDBQXAR.js";
import "./chunk-RNF7VOCU.js";
import "./chunk-TIRJMGGG.js";
import "./chunk-ZDRQSPB6.js";
import "./chunk-DCXDXGAR.js";
import "./chunk-BCCDYCTQ.js";
import "./chunk-AYL3HQHD.js";
import "./chunk-66YQWHHE.js";
import "./chunk-QGBMZIP4.js";
import "./chunk-AOEBZVTA.js";
import "./chunk-2OZSYJDX.js";
import {
  P as P2,
  e as e4,
  g as g2,
  j,
  r as r2,
  s as s2,
  v
} from "./chunk-MZM4INJV.js";
import {
  n as n2
} from "./chunk-J4GMQHGL.js";
import "./chunk-MHPE4SZA.js";
import "./chunk-6SSA7P3A.js";
import "./chunk-FQBTLEUI.js";
import "./chunk-GS7Y3YOG.js";
import "./chunk-Y2HYKTTT.js";
import "./chunk-XLEC46FY.js";
import "./chunk-4AZPIP7K.js";
import {
  C,
  P,
  d
} from "./chunk-LZSLQ24Q.js";
import {
  V
} from "./chunk-U3RHUXYK.js";
import "./chunk-7DBI6LQG.js";
import {
  _,
  a as a2
} from "./chunk-AUUN7RFQ.js";
import "./chunk-JAMSDYD6.js";
import "./chunk-PH6NPTP7.js";
import {
  e as e3
} from "./chunk-NUICEVIH.js";
import "./chunk-NXK752PZ.js";
import {
  y
} from "./chunk-UVNLCXWD.js";
import "./chunk-PNUA7JOS.js";
import "./chunk-OR2FKGUM.js";
import {
  a3 as a
} from "./chunk-UDMPWVPF.js";
import "./chunk-XJNKCEWL.js";
import {
  b,
  g,
  s
} from "./chunk-AIZ3T7E3.js";
import {
  e as e2
} from "./chunk-6UEMNP3E.js";
import {
  e,
  r,
  u
} from "./chunk-6WGE3IUL.js";
import {
  l
} from "./chunk-MLYB2YW4.js";
import {
  n2 as n
} from "./chunk-6JFGZTLU.js";
import {
  A2 as A,
  O,
  t4 as t
} from "./chunk-2ZJE6ZFX.js";
import {
  __async,
  __spreadProps,
  __spreadValues
} from "./chunk-XBPEBUD5.js";

// ../../../node_modules/@arcgis/core/views/3d/layers/PointCloudLayerViewPerformanceInfo.js
var e8 = class extends t7 {
  constructor(s6, e11, o7, r13, i7) {
    super(s6, e11, -1, o7, r13), this.queue = i7;
  }
};
var o3 = class {
  constructor(s6, e11, o7, r13) {
    this.loading = s6, this.indexLoading = e11, this.processing = o7, this.idleProcessing = r13;
  }
};

// ../../../node_modules/@arcgis/core/views/3d/layers/PointCloudWorkerHandle.js
var r8 = class extends h2 {
  constructor(t11) {
    super("PointCloudWorker", "transform", {
      transform: (t12) => u4(t12)
    }, t11);
  }
};
function u4(t11) {
  const r13 = [t11.geometryBuffer];
  if (null != t11.primaryAttributeData && t11.primaryAttributeData.buffer && r13.push(t11.primaryAttributeData.buffer), null != t11.modulationAttributeData && t11.modulationAttributeData.buffer && r13.push(t11.modulationAttributeData.buffer), null != t11.filterAttributesData) for (const u7 of t11.filterAttributesData) null != u7 && u7.buffer && r13.push(u7.buffer);
  for (const u7 of t11.userAttributesData) u7.buffer && r13.push(u7.buffer);
  return r13;
}

// ../../../node_modules/@arcgis/core/views/3d/layers/i3s/LoDUtil.js
function t9(e11, t11, g5) {
  for (let n5 = 0; n5 < t11.length; n5++) r9[n5] = false, o4[n5] = null;
  for (let r13 = 0; r13 < e11.length; r13++) n3[r13] = false, l3[r13] = null;
  for (let n5 = 0; n5 < t11.length; n5++) {
    const o7 = h3(t11[n5], e11, g5);
    o7 >= 0 && (r9[n5] = true, null != l3[o7] ? l3[o7].push(t11[n5]) : l3[o7] = [t11[n5]]);
  }
  for (let l5 = 0; l5 < e11.length; l5++) {
    const r13 = h3(e11[l5], t11, g5);
    r13 >= 0 && (n3[l5] = true, null != o4[r13] ? o4[r13].push(e11[l5]) : o4[r13] = [e11[l5]]);
  }
  const u7 = [];
  for (let r13 = 0; r13 < e11.length; r13++) null != l3[r13] || n3[r13] || u7.push({
    load: [],
    remove: [e11[r13]]
  });
  for (let n5 = 0; n5 < t11.length; n5++) null != o4[n5] || r9[n5] || u7.push({
    load: [t11[n5]],
    remove: []
  });
  for (let n5 = 0; n5 < t11.length; n5++) null != o4[n5] && (o4[n5].length > 1 || o4[n5][0] !== t11[n5]) && u7.push({
    load: [t11[n5]],
    remove: o4[n5]
  });
  for (let n5 = 0; n5 < e11.length; n5++) null != l3[n5] && (l3[n5].length > 1 || l3[n5][0] !== e11[n5]) && u7.push({
    load: l3[n5],
    remove: [e11[n5]]
  });
  return u7;
}
var n3 = [false];
var l3 = [null];
var r9 = [false];
var o4 = [null];
function h3(e11, t11, n5) {
  let l5 = e11;
  for (; l5 > 0; ) {
    const e12 = t11.indexOf(l5);
    if (e12 >= 0) return e12;
    l5 = n5.getParentId(l5);
  }
  return t11.indexOf(l5);
}
function g4(t11, n5, l5) {
  return t11.sort((t12, r13) => {
    if (0 === t12.load.length && 0 === r13.load.length) return 0;
    if (0 === t12.load.length) return -1;
    if (0 === r13.load.length) return 1;
    if (0 === t12.remove.length && 0 === r13.remove.length) {
      const o7 = l5.getRenderObb(t12.load[0]).center, h6 = l5.getRenderObb(r13.load[0]).center;
      return P2(o7, n5) - P2(h6, n5);
    }
    if (0 === t12.remove.length) return -1;
    if (0 === r13.remove.length) return 1;
    if (1 === t12.load.length && 1 === r13.load.length) {
      const o7 = l5.getRenderObb(t12.load[0]).center, h6 = l5.getRenderObb(r13.load[0]).center;
      return P2(o7, n5) - P2(h6, n5);
    }
    if (1 === t12.load.length) return -1;
    if (1 === r13.load.length) return 1;
    {
      const o7 = l5.getRenderObb(t12.remove[0]).center, h6 = l5.getRenderObb(r13.remove[0]).center;
      return P2(o7, n5) - P2(h6, n5);
    }
  });
}
function u5(e11, t11, n5) {
  for (let l5 = 0; l5 < e11.length; ++l5) {
    const r13 = e11[l5];
    r13.load.length > t11 && 1 === r13.remove.length && d3(e11, r13, n5);
  }
}
function d3(e11, t11, n5) {
  const l5 = [t11.remove[0]], r13 = [];
  for (; 1 === l5.length; ) {
    const e12 = l5.pop();
    r13.length = 0;
    for (let o7 = 0; o7 < t11.load.length; o7++) {
      let h6 = t11.load[o7], g5 = n5.getParentId(h6);
      for (; g5 !== e12; ) h6 = g5, g5 = n5.getParentId(h6);
      let u7 = l5.indexOf(h6);
      u7 < 0 && (u7 = l5.length, l5.push(h6), r13.push([])), r13[u7].push(t11.load[o7]);
    }
  }
  t11.load = l5;
  for (let o7 = 0; o7 < l5.length; o7++) r13[o7].length > 1 ? e11.push({
    remove: [l5[o7]],
    load: r13[o7]
  }) : l5[o7] = r13[o7][0];
}

// ../../../node_modules/@arcgis/core/views/3d/layers/i3s/PagedNodeIndex.js
var i6 = class {
  constructor(t11, s6, n5) {
    this._pages = [], this.pageSize = 0, this._nodeSR = t11, this._renderSR = s6, this._renderSRSphericalPCPF = a3(s6), this.pageSize = n5;
  }
  addPage(e11, t11, s6 = 0) {
    for (; this._pages.length < e11; ) this._pages.push(null);
    r10(t11, this._nodeSR, this._renderSR, s6, this._renderSRSphericalPCPF), this._pages[e11] = {
      nodes: t11,
      parents: new Uint32Array(this.pageSize)
    }, p2(this._pages, this.pageSize);
  }
  hasPage(e11) {
    return !!this._pages[e11];
  }
  getNode(e11) {
    const t11 = this.pageSize;
    return this._pages[a5(e11, t11)].nodes[h4(e11, t11)];
  }
  getRenderObb(e11) {
    const t11 = this.pageSize;
    return this._pages[a5(e11, t11)].nodes[h4(e11, t11)].obbInRenderSR;
  }
  setRenderObb(e11, t11) {
    const s6 = this.pageSize;
    this._pages[a5(e11, s6)].nodes[h4(e11, s6)].obbInRenderSR.copy(t11);
  }
  getParentId(e11) {
    const t11 = this.pageSize;
    return this._pages[a5(e11, t11)].parents[h4(e11, t11)];
  }
  hasNodes(e11, t11) {
    const s6 = a5(e11, this.pageSize), n5 = a5(e11 + t11 - 1, this.pageSize);
    for (let i7 = s6; i7 <= n5; i7++) if (null == this._pages[i7]) return false;
    return true;
  }
  forEachNodeId(e11) {
    for (let t11 = 0; t11 < this._pages.length; t11++) {
      const s6 = this._pages[t11];
      if (s6) for (let n5 = 0; n5 < s6.nodes.length; n5++) e11(t11 * this.pageSize + n5);
    }
  }
  createVisibilityTraverse() {
    const e11 = {
      index: this,
      queue: [],
      masks: [],
      tempAabb: i2()
    };
    return (t11, s6) => o5(e11, t11, s6);
  }
};
function o5(e11, t11, i7) {
  const o7 = e11.index;
  if (!o7.hasNodes(0, 1)) return;
  const r13 = e11.queue;
  r13.length = 0, r13.push(0);
  const p3 = e11.masks;
  for (p3.length = 0, p3.push(0); r13.length > 0; ) {
    const h6 = r13.pop();
    let g5 = p3.pop();
    const l5 = o7.getNode(h6), c5 = o7.getRenderObb(h6);
    let u7 = true;
    if (null != t11.clippingBox) {
      const i8 = 1 << t11.frustum.length;
      g5 & i8 || (c5.toAaBoundingBox(e11.tempAabb), b2(t11.clippingBox, e11.tempAabb) ? g5 |= i8 : z(t11.clippingBox, e11.tempAabb) || (u7 = false));
    }
    for (let e12 = 0; e12 < t11.frustum.length && u7; e12++) {
      const s6 = 1 << e12;
      if (!(g5 & s6)) {
        const n5 = c5.intersectPlane(t11.frustum[e12]);
        n5 > 0 ? u7 = false : n5 < 0 && (g5 |= s6);
      }
    }
    if (i7.predicate(h6, l5, u7)) {
      const e12 = l5.firstChild, t12 = l5.childCount;
      let s6 = false;
      const n5 = a5(e12, o7.pageSize), c6 = a5(e12 + t12 - 1, o7.pageSize);
      for (let r14 = n5; r14 <= c6; r14++) if (!o7.hasPage(r14)) {
        i7.pageMiss(h6, r14), s6 = true;
        break;
      }
      if (!s6) for (let i8 = 0; i8 < t12; i8++) r13.push(e12 + i8), p3.push(g5);
    }
  }
}
function r10(e11, t11, s6, n5, i7) {
  for (let o7 = 0; o7 < e11.length; o7++) {
    const r13 = e11[o7];
    r13.obb.transform(r13.obbInRenderSR, t11, s6, n5, i7);
  }
}
function p2(e11, t11) {
  const s6 = [0];
  for (; s6.length; ) {
    const n5 = s6.pop(), i7 = e11[a5(n5, t11)].nodes[h4(n5, t11)];
    for (let o7 = 0; o7 < i7.childCount; o7++) {
      const r13 = i7.firstChild + o7;
      null != e11[a5(r13, t11)] && (e11[a5(r13, t11)].parents[h4(r13, t11)] = n5, s6.push(r13));
    }
  }
}
function a5(e11, t11) {
  return e11 / t11 | 0;
}
function h4(e11, t11) {
  return e11 % t11;
}

// ../../../node_modules/@arcgis/core/views/3d/layers/i3s/PointCloudRendererUtil.js
function t10(t11) {
  const e11 = t11.renderer, n5 = e11?.type, o7 = e11?.toJSON() ?? null;
  let l5 = null, i7 = false;
  const a6 = t11.attributeStorageInfo;
  "point-cloud-unique-value" === n5 || "point-cloud-stretch" === n5 || "point-cloud-class-breaks" === n5 ? l5 = u6(a6, e11.field) : "point-cloud-rgb" === n5 ? (l5 = r11(a6, e11.field), i7 = null != l5) : (l5 = r11(a6, "RGB"), i7 = null != l5);
  let s6 = null;
  return e11?.colorModulation && (s6 = u6(a6, e11.colorModulation.field)), {
    rendererJSON: o7,
    isRGBRenderer: i7,
    primaryAttribute: l5,
    modulationAttribute: s6
  };
}
function e9(t11) {
  const e11 = t11.filters;
  return e11 ? e11.map((e12) => ({
    filterJSON: e12.toJSON(),
    attributeInfo: u6(t11.attributeStorageInfo, e12.field)
  })) : [];
}
function n4(t11) {
  const e11 = t11?.pointSizeAlgorithm;
  return e11 && "splat" === e11.type ? e11 : null;
}
function o6(t11) {
  const e11 = t11?.pointSizeAlgorithm;
  return e11 && "fixed-size" === e11.type ? e11 : null;
}
function l4(t11) {
  const e11 = t11?.pointSizeAlgorithm;
  return !!e11?.type && "fixed-size" === e11.type;
}
function r11(t11, e11) {
  for (const n5 of t11 ?? []) if (n5.name === e11 && null != n5.attributeValues && "UInt8" === n5.attributeValues.valueType && 3 === n5.attributeValues.valuesPerElement) return {
    name: e11,
    storageInfo: n5,
    useElevation: false
  };
  return null;
}
function u6(t11, e11) {
  for (const n5 of t11 ?? []) if (n5.name === e11) {
    const t12 = "embedded-elevation" === n5.encoding;
    return t12 ? {
      name: e11,
      storageInfo: null,
      useElevation: t12
    } : {
      name: e11,
      storageInfo: n5,
      useElevation: t12
    };
  }
  return "elevation" === e11?.toLowerCase() ? {
    name: e11,
    storageInfo: null,
    useElevation: true
  } : null;
}

// ../../../node_modules/@arcgis/core/views/3d/layers/i3s/PointGraphic.js
var e10 = class extends d2 {
  constructor(o7) {
    super(o7), this.pointCloudMetadata = null;
  }
};
e3([y({
  constructOnly: true,
  clonable: "reference"
})], e10.prototype, "pointCloudMetadata", void 0), e10 = e3([a("esri.views.3d.layers.i3s.PointGraphic")], e10);

// ../../../node_modules/@arcgis/core/views/3d/layers/i3s/PointHighlights.js
var h5 = class {
  constructor(e11) {
    this._context = e11, this._highlights = /* @__PURE__ */ new Set();
  }
  get empty() {
    return 0 === this._highlights.size;
  }
  destroy() {
    this._highlights = null;
  }
  add(t11) {
    const i7 = new s5(t11);
    return this._highlights.add(i7), this._enableSet(i7), e2(() => this._removeSet(i7));
  }
  _removeSet(e11) {
    this._disableSet(e11), this._highlights.delete(e11);
  }
  _enableSet(e11) {
    e11.enabled || (e11.enabled = true, this._context.forEachNode((t11) => this._enableSetForNode(e11, t11)));
  }
  _enableSetForNode(e11, t11) {
    if (!e11.enabled) return;
    const i7 = e11.ids.get(t11.id);
    i7 && i7.forEach((i8) => this._context.addHighlight(t11, i8, e11.id));
  }
  _disableSet(e11) {
    e11.enabled && (e11.enabled = false, this._context.forEachNode((t11) => this._disableSetForNode(e11, t11)));
  }
  _disableSetForNode(e11, t11) {
    e11.enabled || this._context.removeHighlight(t11, e11.id);
  }
  nodeAdded(e11) {
    this._highlights.forEach((t11) => this._enableSetForNode(t11, e11));
  }
  nodeRemoved(e11) {
    this._highlights.forEach((t11) => this._disableSetForNode(t11, e11));
  }
  removeAll() {
    this._highlights.forEach((e11) => this._disableSet(e11));
  }
};
var s5 = class {
  constructor(e11) {
    this.id = new r3(t4.Highlight), this.ids = /* @__PURE__ */ new Map(), this.enabled = false;
    for (const t11 of e11) null != t11 && this._add(t11.nodeId, t11.pointId);
  }
  _add(e11, t11) {
    const i7 = this.ids.get(e11);
    i7 ? i7.add(t11) : this.ids.set(e11, /* @__PURE__ */ new Set([t11]));
  }
};

// ../../../node_modules/@arcgis/core/views/3d/webgl-engine/shaders/PointRendererTechnique.js
var d4 = class _d extends r4 {
  constructor(e11, r13, t11) {
    super(e11, r13, t11);
  }
  initializeProgram(e11) {
    return new r5(e11.rctx, _d.shader.get().build(this.configuration), O4);
  }
  initializePipeline() {
    return S({
      depthTest: {
        func: O3.LESS
      },
      depthWrite: o2,
      colorWrite: _3,
      stencilWrite: this.configuration.hasOccludees ? e6 : null,
      stencilTest: this.configuration.hasOccludees ? f2 : null,
      drawBuffers: this.configuration.output === o.Depth ? {
        buffers: [f.NONE]
      } : null
    });
  }
};
d4.shader = new t5(_4, () => import("./PointRenderer.glsl-T5NNBOB7.js"));

// ../../../node_modules/@arcgis/core/views/3d/webgl-engine/shaders/PointRendererTechniqueConfiguration.js
var r12 = class extends t6 {
  constructor() {
    super(...arguments), this.output = o.Color, this.hasSlicePlane = false, this.drawScreenSize = false, this.useFixedSizes = false, this.hasOccludees = false, this.clippingEnabled = false;
  }
};
e3([r6({
  count: o.COUNT
})], r12.prototype, "output", void 0), e3([r6()], r12.prototype, "hasSlicePlane", void 0), e3([r6()], r12.prototype, "drawScreenSize", void 0), e3([r6()], r12.prototype, "useFixedSizes", void 0), e3([r6()], r12.prototype, "hasOccludees", void 0), e3([r6()], r12.prototype, "clippingEnabled", void 0), e3([r6({
  constValue: true
})], r12.prototype, "hasSliceInVertexProgram", void 0);

// ../../../node_modules/@arcgis/core/views/3d/layers/i3s/PointRenderer.js
var W = {
  positions: [new t2(e5.POSITION, 3, C2.FLOAT, 0, 12)],
  colors: [new t2(e5.COLOR, 3, C2.UNSIGNED_BYTE, 0, 3, true)]
};
var k2 = class extends c4 {
  constructor(e11) {
    super(e11), this.type = i4.PCL, this.isGround = false, this._passParameters = new j2(), this._highlights = new h5({
      forEachNode: (e12) => this.forEachNode(e12),
      addHighlight: (e12, s6, t11) => this._addHighlight(e12, s6, t11),
      removeHighlight: (e12, s6) => this._removeHighlight(e12, s6)
    }), this.produces = /* @__PURE__ */ new Map([[E3.OPAQUE_MATERIAL, (e12) => !(g3(e12) || e12 === o.Highlight && this._highlights.empty)], [E3.OPAQUE_NO_SSAO_DEPTH, (e12) => g3(e12)]]), this.layerUid = "", this._slicePlaneEnabled = false, this._techniqueConfig = new r12(), this._nodes = new l();
  }
  initializeRenderContext(e11) {
    this._context = e11, e11.requestRender();
  }
  uninitializeRenderContext() {
  }
  intersect(e11, s6, t11, i7) {
    const r13 = n2(), f3 = n2(), P4 = n2(), b3 = n2(), w = E(), R = e11.camera.perScreenPixelRatio / 2, A3 = e11.camera.near;
    e4(f3, i7, t11);
    const j3 = 1 / s2(f3);
    g2(f3, f3, j3), j(P4, f3), s3(w, f3[0], f3[1], f3[2], -P2(f3, t11));
    const q = new ee(), O6 = new ee(), I3 = new Array(), v3 = i2(), F2 = i2(this._passParameters.clipBox);
    Y(F2, -t11[0], -t11[1], -t11[2], F2), this._nodes.forAll((o7) => {
      const a6 = o7.splatSize * this._passParameters.scaleFactor;
      let l5 = o7.obb.minimumDistancePlane(w), d5 = o7.obb.maximumDistancePlane(w);
      l5 -= J(a6, l5 + A3, this._passParameters, R, o7.isLeaf), d5 -= J(a6, d5 + A3, this._passParameters, R, o7.isLeaf);
      const u7 = d5 < 0, m2 = null != q.dist && null != O6.dist && q.dist < l5 * j3 && O6.dist > d5 * j3;
      if (u7 || m2) return;
      const S2 = Y2(a6, d5 + A3, this._passParameters, R, o7.isLeaf);
      if (!o7.obb.intersectRay(t11, f3, S2)) return;
      const x2 = S2 * S2;
      o7.obb.toAaBoundingBox(v3), Y(v3, -t11[0], -t11[1], -t11[2], v3);
      const z2 = !b2(F2, v3);
      e4(b3, o7.origin, t11);
      const y4 = o7.coordinates.length / 3;
      for (let n5 = 0; n5 < y4; n5++) {
        if (r13[0] = b3[0] + o7.coordinates[3 * n5], r13[1] = b3[1] + o7.coordinates[3 * n5 + 1], r13[2] = b3[2] + o7.coordinates[3 * n5 + 2], z2 && !y2(F2, r13)) continue;
        const l6 = P2(r13, f3), d6 = v(r13) - l6 * l6;
        if (d6 > x2) continue;
        let u8 = l6 + A3;
        const m3 = J(a6, u8, this._passParameters, R, o7.isLeaf);
        if (l6 - m3 < 0) continue;
        u8 -= m3;
        const p3 = Y2(a6, u8, this._passParameters, R, o7.isLeaf);
        if (d6 > p3 * p3) continue;
        const g5 = (l6 - m3) * j3, S3 = (e12) => (e12.point = K(o7, n5, e12.point), e12.dist = g5, e12.normal = P4, e12.node = o7, e12.pointId = n5, e12.layerUid = this.layerUid, e12);
        if ((null == q.dist || g5 < q.dist) && (null == s6 || s6(t11, i7, g5)) && S3(q), e11.options.store !== e7.MIN && (null == O6.dist || g5 > O6.dist) && (null == s6 || s6(t11, i7, g5)) && S3(O6), e11.options.store === e7.ALL && (null == s6 || s6(t11, i7, g5))) {
          const e12 = new ee();
          I3.push(S3(e12));
        }
      }
    });
    const N = (e12) => {
      const {
        layerUid: s7,
        node: t12,
        pointId: i8
      } = e12;
      return new s4(e12.point, s7, i8, () => this.createGraphic(t12, i8, e12.point));
    }, C3 = (e12, s7) => {
      const t12 = N(s7);
      e12.set(this.type, t12, s7.dist, s7.normal);
    };
    if (se2(q)) {
      const s7 = e11.results.min;
      (null == s7.dist || q.dist < s7.dist) && C3(s7, q);
    }
    if (se2(O6) && e11.options.store !== e7.MIN) {
      const s7 = e11.results.max;
      (null == s7.dist || O6.dist > s7.dist) && C3(s7, O6);
    }
    if (e11.options.store === e7.ALL) {
      const s7 = k(t11, i7);
      for (const t12 of I3) {
        const i8 = G(s7);
        C3(i8, t12), e11.results.all.push(i8);
      }
    }
  }
  prepareTechnique(e11) {
    return 0 !== this._nodes.length && (e11.output === o.Color || g3(e11.output) && e11.bindParameters.slot === E3.OPAQUE_NO_SSAO_DEPTH || e11.output === o.Highlight) ? (this._nodes.forAll((s6) => {
      null == s6.vao && this._initNode(e11, s6);
    }), this._techniqueConfig.drawScreenSize = this._passParameters.drawScreenSpace, this._techniqueConfig.useFixedSizes = this._passParameters.useFixedSizes, this._techniqueConfig.hasSlicePlane = this._slicePlaneEnabled, this._techniqueConfig.hasOccludees = e11.bindParameters.hasOccludees, this._techniqueConfig.clippingEnabled = this._clippingEnabled, this._techniqueConfig.output = e11.output, this._context.techniques.releaseAndAcquire(d4, this._techniqueConfig, this._technique)) : null;
  }
  renderNode(e11, s6) {
    const t11 = e11.rctx, i7 = t11.bindTechnique(s6, e11.bindParameters, this._passParameters), r13 = e11.output === o.Highlight;
    this._nodes.forAll((s7) => {
      0 === s7.coordinates.length || r13 && !s7.highlights || (i7.bindDraw(s7, e11.bindParameters, this._passParameters), t11.bindVAO(s7.vao), r13 ? this._renderHighlightFragments(t11, s7) : t11.drawArrays(E2.POINTS, 0, s7.coordinates.length / 3));
    });
  }
  _renderHighlightFragments(e11, s6) {
    const t11 = s6.highlights;
    if (null == t11) return;
    let i7 = t11[0].component, r13 = i7 + 1;
    for (let o7 = 1; o7 < t11.length; o7++) {
      const s7 = t11[o7].component;
      if (s7 !== r13) {
        const t12 = r13 - i7;
        t12 > 0 && e11.drawArrays(E2.POINTS, i7, t12), i7 = s7;
      }
      r13 = s7 + 1;
    }
    const n5 = r13 - i7;
    n5 > 0 && e11.drawArrays(E2.POINTS, i7, n5);
  }
  set useFixedSizes(e11) {
    this._passParameters.useFixedSizes !== e11 && (this._passParameters.useFixedSizes = e11, this._requestRender());
  }
  get useFixedSizes() {
    return this._passParameters.useFixedSizes;
  }
  set scaleFactor(e11) {
    this._passParameters.scaleFactor !== e11 && (this._passParameters.scaleFactor = e11, this._requestRender());
  }
  get scaleFactor() {
    return this._passParameters.scaleFactor;
  }
  set minSizePx(e11) {
    this._passParameters.minSizePx !== e11 && (this._passParameters.minSizePx = e11, this._requestRender());
  }
  get minSizePx() {
    return this._passParameters.minSizePx;
  }
  set useRealWorldSymbolSizes(e11) {
    this._passParameters.useRealWorldSymbolSizes !== e11 && (this._passParameters.useRealWorldSymbolSizes = e11, this._requestRender());
  }
  get useRealWorldSymbolSizes() {
    return this._passParameters.useRealWorldSymbolSizes;
  }
  set size(e11) {
    this._passParameters.size !== e11 && (this._passParameters.size = e11, this._requestRender());
  }
  get size() {
    return this._passParameters.size;
  }
  set sizePx(e11) {
    this._passParameters.sizePx !== e11 && (this._passParameters.sizePx = e11, this._requestRender());
  }
  get sizePx() {
    return this._passParameters.sizePx;
  }
  set clippingBox(e11) {
    O2(this._passParameters.clipBox, e11 || v2);
  }
  get _clippingEnabled() {
    return !B(this._passParameters.clipBox, v2, (e11, s6) => e11 === s6);
  }
  get slicePlaneEnabled() {
    return this._slicePlaneEnabled;
  }
  set slicePlaneEnabled(e11) {
    this._slicePlaneEnabled !== e11 && (this._slicePlaneEnabled = e11, this._requestRender());
  }
  addNode(e11) {
    this._nodes.push(e11), this._highlights.nodeAdded(e11), this._requestRender();
  }
  removeNode(e11) {
    let t11 = null;
    return this._nodes.filterInPlace((i7) => i7.id !== e11 || (t11 = i7, i7.vao = r(i7.vao), this._highlights.nodeRemoved(i7), false)), this._requestRender(), t11;
  }
  forEachNode(e11) {
    this._nodes.forAll(e11);
  }
  removeAll() {
    this._nodes.forAll((e11) => e11.vao = r(e11.vao)), this._highlights.removeAll(), this._nodes.clear(), this._requestRender();
  }
  highlight(e11) {
    return this._highlights.add(e11);
  }
  _addHighlight(e11, s6, t11) {
    e11.highlights = Z(e11.highlights, s6, t11), this._requestRender();
  }
  _removeHighlight(e11, s6) {
    e11.highlights = $(e11.highlights, s6), this._requestRender();
  }
  _initNode(e11, s6) {
    const t11 = e11.rctx;
    s6.vao = new r7(t11, O4, W, {
      positions: c.createVertex(t11, F.STATIC_DRAW, s6.coordinates),
      colors: c.createVertex(t11, F.STATIC_DRAW, s6.rgb)
    });
  }
  _requestRender() {
    this._context && this._context.requestRender();
  }
};
e3([y({
  constructOnly: true
})], k2.prototype, "createGraphic", void 0), k2 = e3([a("esri.views.3d.layers.i3s.PointRenderer")], k2);
var G2 = class extends P3 {
  constructor(e11, s6, t11, i7, r13, n5, o7, a6, l5 = null, h6 = null) {
    super(t11, r13, s6), this.id = e11, this.obb = i7, this.coordinates = n5, this.rgb = o7, this.attributes = a6, this.pointIdFilterMap = l5, this.highlights = h6;
  }
};
function Q(e11) {
  return e11.hasOwnProperty("splatSize");
}
function Y2(e11, s6, t11, i7, r13) {
  if (t11.drawScreenSpace) return t11.fixedSize * s6 * i7;
  const n5 = O5(r13) * s6 * i7;
  return t11.useFixedSizes ? Math.min(t11.fixedSize / 2, n5) : t11.screenMinSize > 0 ? Math.min(Math.max(t11.screenMinSize * s6 * i7, e11 / 2), n5) : Math.min(e11 / 2, n5);
}
function J(e11, s6, t11, i7, r13) {
  return t11.drawScreenSpace ? 0 : Y2(e11, s6, t11, i7, r13);
}
function K(e11, s6, t11) {
  return null == t11 && (t11 = n2()), t11[0] = e11.origin[0] + e11.coordinates[3 * s6], t11[1] = e11.origin[1] + e11.coordinates[3 * s6 + 1], t11[2] = e11.origin[2] + e11.coordinates[3 * s6 + 2], t11;
}
function X(e11) {
  return null != e11.component ? e11.component : -1;
}
function Z(e11, s6, t11) {
  null == e11 && (e11 = []);
  const i7 = {
    component: s6,
    id: t11
  };
  e11.push(i7);
  const r13 = X(i7);
  let n5 = e11.length - 1;
  for (; n5 > 0 && r13 < X(e11[n5 - 1]); ) [e11[n5 - 1], e11[n5]] = [e11[n5], e11[n5 - 1]], --n5;
  return e11;
}
function $(e11, s6) {
  if (null == e11) return e11;
  const t11 = e11.filter((e12) => e12.id !== s6);
  return 0 === t11.length ? null : t11;
}
var ee = class {
  constructor() {
    this.node = null, this.pointId = null, this.point = null, this.dist = null, this.normal = null, this.layerUid = "";
  }
};
function se2(e11) {
  return null != e11.dist && null != e11.point && null != e11.pointId && null != e11.node;
}

// ../../../node_modules/@arcgis/core/views/3d/layers/PointCloudLayerView3D.js
var le = 8;
var he = E();
var ue = class extends i5(l2(y3)) {
  constructor() {
    super(...arguments), this.type = "point-cloud-3d", this.maximumPointCount = 4e6, this.slicePlaneEnabled = false, this._renderer = null, this._rendererAdded = false, this._renderedNodes = /* @__PURE__ */ new Set(), this._updateViewNeeded = true, this._lodFactor = 1, this._maxLoggedBoxWarnings = 5, this._pageMultiplier = 1, this._nodeLoadEpoch = 0, this._indexQueue = [], this._workQueue = new Array(), this._idleQueue = new i3(), this._indexPagesLoading = /* @__PURE__ */ new Map(), this._loadingNodes = /* @__PURE__ */ new Map(), this._recalcWork = true, this._layerIsVisible = false, this._codedDomainPopulationPromise = null, this._codedDomainPopulationAbortController = null, this._totalWork = 0, this._index = null, this._loadingInitNodePage = false, this._nodeIdArray = [], this.ignoresMemoryFactor = false;
  }
  get baseUrl() {
    return this.layer.parsedUrl?.path ?? "";
  }
  get pointScale() {
    const e11 = n4(this.layer?.renderer), t11 = 1;
    return null != e11?.scaleFactor ? e11.scaleFactor : t11;
  }
  get useRealWorldSymbolSizes() {
    const e11 = o6(this.layer?.renderer), t11 = false;
    return null != e11?.useRealWorldSymbolSizes ? e11.useRealWorldSymbolSizes : t11;
  }
  get pointSize() {
    const e11 = o6(this.layer?.renderer), t11 = 0;
    return null != e11?.size ? e11.size : t11;
  }
  get inverseDensity() {
    const e11 = 96;
    return this.layer?.renderer ? 1 * e11 / this.layer.renderer.pointsPerInch : 5;
  }
  get availableFields() {
    const e11 = t10(this.layer), t11 = /* @__PURE__ */ new Set();
    e11.primaryAttribute && t11.add(e11.primaryAttribute.name), e11.modulationAttribute && t11.add(e11.modulationAttribute.name);
    const i7 = e9(this.layer);
    if (i7) for (const r13 of i7) r13.attributeInfo && t11.add(r13.attributeInfo.name);
    if (this.layer.outFields) for (const r13 of x(this.layer.fieldsIndex, this.layer.outFields)) t11.add(r13);
    return Array.from(t11);
  }
  get _clippingBox() {
    if (!this.view || !this.view.clippingArea) return null;
    const e11 = i2(), t11 = this.view.renderSpatialReference;
    return m(this.view.clippingArea, e11, t11) ? e11 : null;
  }
  get _elevationOffset() {
    const e11 = this.layer && this.layer.elevationInfo;
    return e11 && "absolute-height" === e11.mode ? h(e11, this.layer.spatialReference) : 0;
  }
  initialize() {
    const e11 = this.view.resourceController, t11 = me(e11);
    this._worker = new r8(t11), this.addResolvingPromise(this._worker.promise), ae(this.layer), se(this.layer, this.view), this._indexRequester = e11.createStreamDataRequester(A2.I3S_INDEX), this._dataRequester = e11.createStreamDataRequester(A2.I3S_DATA), this._initRenderer();
    const i7 = this._initNodePages(), r13 = this.view.resourceController.memoryController;
    this._memCache = r13.newCache(`pcl-${this.layer.uid}`), this._updatingHandles.add(() => this._clippingBox, () => this._setUpdateViewNeeded(), P), this._updatingHandles.add(() => this._elevationOffset, () => this._elevationOffsetChanged(), P), this._updatingHandles.add(() => this.layer.renderer, () => this._rendererChanged(), P), this._updatingHandles.add(() => this.layer.filters, () => this._reload(), P), this._updatingHandles.add(() => this.layer.outFields, () => this._reload(), P), this._updatingHandles.add(() => this.layer.effectiveScaleRange, () => this._setUpdateViewNeeded()), this._updatingHandles.add(() => this.view.state.contentCamera, () => this._setUpdateViewNeeded()), this.addHandles([d(() => this.view.quality, () => this._setUpdateViewNeeded(), C)]), this.addResolvingPromise(i7), this.when(() => {
      this.addHandles([e11.scheduler.registerTask(I2.POINT_CLOUD_LAYER, this), e11.scheduler.registerIdleStateCallbacks(() => this._idleBegin(), () => this._idleEnd()), this._updatingHandles.add(() => this.suspended, (e12) => {
        e12 ? this._clearNodeState() : this._setUpdateViewNeeded();
      }, P)]);
    }, () => {
      this._updatingHandles.removeAll(), this.removeAllHandles();
    });
  }
  _setUpdateViewNeeded() {
    this._updateViewNeeded = true, this._updateLoading();
  }
  destroy() {
    this.cancelLoading(), this._worker = u(this._worker), this._destroyRenderer(), this._memCache = u(this._memCache), this._codedDomainPopulationAbortController = e(this._codedDomainPopulationAbortController), this._codedDomainPopulationPromise = null;
  }
  _initRenderer() {
    this._renderer = new k2({
      createGraphic: (e11, t11, i7) => this._createGraphic(e11, t11, i7)
    }), this._renderer.layerUid = this.layer.uid, this._updatingHandles.add(() => this._clippingBox, (e11) => this._renderer.clippingBox = e11, P), this._updatingHandles.add(() => this.suspended, (e11) => this._setPointsVisible(!e11), P), this._updatingHandles.add(() => this.pointScale, (e11) => this._renderer.scaleFactor = e11, P), this._renderer.minSizePx = Math.sqrt(2), this._updatingHandles.add(() => this.useRealWorldSymbolSizes, (e11) => this._renderer.useRealWorldSymbolSizes = e11, P), this._updatingHandles.add(() => this.pointSize, (e11) => {
      const t11 = u2(e11);
      this._renderer.size = e11, this._renderer.sizePx = t11;
    }, P), this._updatingHandles.add(() => this.slicePlaneEnabled, (e11) => this._renderer.slicePlaneEnabled = e11, P), this._updatingHandles.add(() => this.inverseDensity, () => this._setUpdateViewNeeded(), P), this._updatingHandles.add(() => this.maximumPointCount, () => this._setUpdateViewNeeded(), P), this._updatingHandles.add(() => this.view.qualitySettings.sceneService.pointCloud.lodFactor, (e11) => {
      this._lodFactor = e11, this._setUpdateViewNeeded();
    }, P);
  }
  _destroyRenderer() {
    this._renderer.removeAll(), this._setPointsVisible(false);
  }
  _createGraphic(e11, t11, i7) {
    const r13 = null != e11.pointIdFilterMap ? e11.pointIdFilterMap[t11] : t11, s6 = L(this.view, i7), o7 = this._createGraphicAttributes(e11, r13);
    return new e10({
      pointCloudMetadata: {
        nodeId: e11.id,
        pointIndexInNode: t11,
        attributePointIndexInNode: r13,
        epoch: this._nodeLoadEpoch
      },
      geometry: s6,
      attributes: o7,
      layer: this.layer,
      sourceLayer: this.layer
    });
  }
  _createGraphicAttributes(e11, t11) {
    const i7 = {};
    for (const r13 of e11.attributes) this._encodeGraphicAttribute(r13.attributeInfo, r13.values, t11, i7);
    return i7;
  }
  _encodeGraphicAttribute(e11, t11, i7, r13) {
    const s6 = e11.storageInfo?.attributeValues, o7 = s6?.valuesPerElement ?? 1;
    if (1 === o7) r13[e11.name] = t11[i7];
    else if ("UInt8" === s6?.valueType && o7 <= 4) {
      let s7 = 0;
      const n5 = i7 * o7;
      for (let e12 = n5; e12 < n5 + o7; e12++) s7 = (s7 << 8) + t11[e12];
      r13[e11.name] = s7;
    } else r13[e11.name] = void 0;
  }
  _setPointsVisible(e11) {
    e11 && !this._rendererAdded ? (this.view._stage.addRenderPlugin(this._renderer), this._rendererAdded = true) : !e11 && this._rendererAdded && (this.view._stage.removeRenderPlugin(this._renderer), this._rendererAdded = false);
  }
  _rendererChanged() {
    this._renderer.useFixedSizes = l4(this.layer.renderer), this._reload();
  }
  _reload() {
    this._clearNodeState(), this._memCache.clear(), this._setUpdateViewNeeded();
  }
  _elevationOffsetChanged() {
    this._clearNodeState(), this._memCache.clear(), this._initNodePages();
  }
  _displayNodes(e11) {
    this._workQueue = t9([...this._renderedNodes], e11, this._index), g4(this._workQueue, this.view.state.contentCamera.viewForward, this._index), u5(this._workQueue, le, this._index), this._updateQueues(), this._totalWork = this._computeWork(), this._updateLoading(), this._layerIsVisible = e11.length > 0 || this._loadingInitNodePage, this.notifyChange("suspended");
  }
  cancelLoading() {
    this._cancelNodeLoading(), this._cancelIndexLoading();
  }
  _cancelNodeLoading() {
    const e11 = new Array();
    this._loadingNodes.forEach(({
      abortController: t11
    }) => e11.push(t11)), this._loadingNodes.clear();
    for (const t11 of e11) t11.abort();
    this._workQueue = [], this._idleQueue.cancelAll(), this._totalWork = this._computeWork(), this._updateLoading();
  }
  _updateQueues() {
    const e11 = /* @__PURE__ */ new Set();
    this._workQueue.forEach((t12) => t12.load.forEach((t13) => e11.add(t13)));
    const t11 = new Array(), i7 = /* @__PURE__ */ new Map();
    this._loadingNodes.forEach((r13, s6) => {
      e11.has(s6) ? i7.set(s6, r13) : t11.push(r13);
    }), this._loadingNodes = i7;
    for (const {
      abortController: r13
    } of t11) r13.abort();
    this._workQueue = this._workQueue.filter((e12) => {
      for (const t12 of e12.load) if (this._loadingNodes.has(t12)) return this._recalcWork = true, false;
      return true;
    }), this._totalWork = this._computeWork(), this._updateLoading();
  }
  _cancelIndexLoading() {
    this._indexQueue = [], this._indexPagesLoading.forEach(({
      abortController: e11
    }) => e11.abort()), this._indexPagesLoading.clear(), this._totalWork = this._computeWork(), this._updateLoading();
  }
  _clearNodeState() {
    this._nodeLoadEpoch++, this._renderedNodes.forEach((e11) => this._removeFromRenderer(e11)), this._cancelNodeLoading();
  }
  _idleBegin() {
    this._setUpdateViewNeeded();
  }
  _idleEnd() {
    this._setUpdateViewNeeded();
  }
  get running() {
    return this.suspended ? this._updateViewNeeded : this._updateViewNeeded || this._indexQueue.length > 0 || this._workQueue.length > 0 || this._idleQueue.running;
  }
  runTask(e11) {
    if (this.suspended) {
      if (this._updateViewNeeded) {
        this._updateViewNeeded = false;
        const e12 = this._isRootNodeVisible();
        e12 !== this._layerIsVisible && (this._layerIsVisible = e12, this.notifyChange("suspended")), this._updateLoading();
      }
    } else {
      for (e11.run(() => this._updateWorkQueues()); this._indexQueue.length > 0 && e11.run(() => this._processIndexQueue()); ) ;
      this._processWorkQueue(e11), this._idleQueue.runTask(e11);
    }
  }
  _processIndexQueue() {
    const e11 = this._indexQueue.shift(), t11 = this._loadNodePage(e11);
    return this._indexPagesLoading.set(e11, t11), t11.promise.then((t12) => {
      this._index.addPage(e11, t12, this._elevationOffset), this._setUpdateViewNeeded();
    }).then(() => {
      this._indexPagesLoading.delete(e11);
    }, () => {
      this._indexPagesLoading.delete(e11);
    }), true;
  }
  _processWorkQueue(e11) {
    for (; !e11.done; ) {
      const t11 = this._scheduleWorkEntry();
      if (null == t11) return void e11.madeProgress();
      this._processWorkEntry(t11), e11.madeProgress();
    }
  }
  _scheduleWorkEntry() {
    let e11 = this._workQueue.length;
    for (; e11--; ) {
      const e12 = this._workQueue.shift();
      if (!e12.remove.find((e13) => !this._renderedNodes.has(e13))) return e12;
      this._workQueue.push(e12);
    }
    return null;
  }
  _processWorkEntry(e11) {
    if (0 !== e11.load.length) Promise.all(e11.load.map((e12) => {
      const t11 = new AbortController(), i7 = this._memCache.pop(e12.toString());
      return null != i7 ? this._loadingNodes.set(e12, {
        abortController: t11,
        promise: Promise.resolve(i7)
      }) : this._loadingNodes.has(e12) || this._loadingNodes.set(e12, {
        abortController: t11,
        promise: this._loadNode(e12, t11.signal)
      }), this._loadingNodes.get(e12).promise;
    })).then((t11) => {
      for (let i7 = 0; i7 < e11.load.length; i7++) if (t11[i7]) {
        const r13 = this._setupRendererData(e11.load[i7], t11[i7]);
        this._addToRenderer(r13);
      }
      for (const i7 of e11.remove) this._removeFromRenderer(i7);
    }).catch(() => {
    }).then(() => {
      for (const t11 of e11.load) this._loadingNodes.delete(t11);
      this._updateLoading(), this._recalcWork && !this._idleQueue.running && 0 === this._indexQueue.length && 0 === this._loadingNodes.size && (this._recalcWork = false, this._setUpdateViewNeeded());
    }), this._updateLoading();
    else for (const t11 of e11.remove) this._removeFromRenderer(t11);
  }
  _populateClassCodeCodedDomain(e11, t11) {
    return __async(this, null, function* () {
      const r13 = "CLASS_CODE", s6 = this.layer.fieldsIndex.get(r13);
      if (!s6 || s6.domain) return;
      if (!e11.includes(s6.name)) return;
      const o7 = yield _(this.layer.queryCachedStatistics(r13, {
        signal: t11
      }));
      if (false === o7.ok) return;
      const n5 = o7.value?.stats?.labels?.labels;
      n5 && Array.isArray(n5) && (s6.domain = new i({
        name: "CLASS_CODE",
        codedValues: n5.map((e12) => new p({
          code: e12.value,
          name: e12.label
        }))
      }));
    });
  }
  prepareFetchPopupFeatures(e11) {
    return __async(this, null, function* () {
      return this._codedDomainPopulationPromise || (this._codedDomainPopulationAbortController = new AbortController(), this._codedDomainPopulationPromise = this._populateClassCodeCodedDomain(e11, this._codedDomainPopulationAbortController.signal).then(() => {
        this._codedDomainPopulationAbortController = null;
      })), this._codedDomainPopulationPromise;
    });
  }
  whenGraphicAttributes(e11, i7) {
    return __async(this, null, function* () {
      const s6 = this._splitGraphicsPerNode(e11), o7 = this.layer.attributeStorageInfo, n5 = i7.map((e12) => u6(o7, e12)).filter(O), a6 = (e12, t11) => __async(this, null, function* () {
        const i8 = this._index.getNode(t11);
        yield a2(n5, (t12) => __async(this, null, function* () {
          const r13 = t12.useElevation ? yield this._loadElevationAttributeFromGeometry(i8.resourceId) : yield this._loadAndParseAttribute(i8, t12);
          if (r13) {
            for (const i9 of e12) if (this._isValidPointGraphic(i9)) {
              const e13 = i9.pointCloudMetadata.attributePointIndexInNode;
              this._encodeGraphicAttribute(t12, r13, e13, i9.attributes);
            }
          }
        }));
      }), d5 = [];
      return s6.forEach((e12, t11) => {
        d5.push(a6(e12, t11));
      }), yield Promise.allSettled(d5), e11;
    });
  }
  _isValidPointGraphic(e11) {
    return e11 instanceof e10 && e11.pointCloudMetadata?.epoch === this._nodeLoadEpoch;
  }
  _splitGraphicsPerNode(e11) {
    const t11 = /* @__PURE__ */ new Map();
    for (const i7 of e11) {
      if (!this._isValidPointGraphic(i7)) continue;
      const e12 = i7.pointCloudMetadata, r13 = t11.get(e12.nodeId);
      r13 ? r13.push(i7) : t11.set(e12.nodeId, [i7]);
    }
    return t11;
  }
  _loadAndParseAttribute(e11, t11) {
    return __async(this, null, function* () {
      const i7 = yield this._loadAttribute(e11.resourceId, t11, null);
      return null != i7 ? c2({
        attributeInfo: t11,
        buffer: i7
      }, null, e11.vertexCount) : null;
    });
  }
  _loadElevationAttributeFromGeometry(e11) {
    return __async(this, null, function* () {
      const t11 = this.layer.store.defaultGeometrySchema, i7 = u3(t11, yield this._loadGeometry(e11, null));
      return a4(i7, i7.length / 3);
    });
  }
  highlight(e11) {
    if (!e11) return e2();
    const t11 = V.isCollection(e11) ? e11.toArray() : Array.isArray(e11) ? e11 : [e11];
    return this._renderer.highlight(t11.map((e12) => this._graphicToPointDefinition(e12)));
  }
  _graphicToPointDefinition(e11) {
    if (!this._isValidPointGraphic(e11)) return null;
    const {
      nodeId: t11,
      pointIndexInNode: i7
    } = e11.pointCloudMetadata;
    return null != t11 && null != i7 ? {
      nodeId: t11,
      pointId: i7
    } : null;
  }
  _computeWork() {
    let e11 = 0;
    for (const t11 of this._workQueue) e11 += t11.load.length + t11.remove.length;
    return e11 += this._loadingNodes.size, e11 += (this._indexQueue.length + this._indexPagesLoading.size) * this._index.pageSize, e11 += this._loadingInitNodePage ? 100 : 0, e11 += this._updateViewNeeded ? 100 : 0, e11;
  }
  get updatingProgressValue() {
    if (this.suspended) return this._updateViewNeeded ? 0 : 1;
    const e11 = this._computeWork();
    return 1 - Math.min(this._totalWork, e11) / this._totalWork;
  }
  _updateLoading() {
    this.notifyChange("updating"), this.notifyChange("updatingProgressValue");
  }
  canResume() {
    return super.canResume() && this._layerIsVisible;
  }
  isUpdating() {
    return this.suspended ? this._updateViewNeeded : this._computeWork() > 0;
  }
  get visibleAtCurrentScale() {
    return c3(this.layer.effectiveScaleRange, this.view.terrainScale);
  }
  _initNodePages() {
    const e11 = this.layer.store.index, t11 = e11.nodesPerPage || e11.nodePerIndexBlock;
    return this._index = new i6(this.layer.spatialReference, this.view.renderCoordsHelper.spatialReference, t11), this._cancelIndexLoading(), this._traverseVisible = this._index.createVisibilityTraverse(), this._loadingInitNodePage = true, this._layerIsVisible = true, this.notifyChange("suspended"), this._updateLoading(), this._pageMultiplier = null != e11.nodesPerPage ? 1 : e11.nodePerIndexBlock, this._loadNodePage(0).promise.then((e12) => {
      this._index.addPage(0, e12, this._elevationOffset), this._loadingInitNodePage = false, this._setUpdateViewNeeded();
    });
  }
  _loadNodePage(e11) {
    const t11 = new AbortController(), i7 = `${this.baseUrl}/nodepages/${e11 * this._pageMultiplier}`;
    return {
      promise: this._requestNodePage(i7, t11.signal).then((t12) => t12.nodes.map((t13, i8) => ({
        resourceId: null != t13.resourceId ? t13.resourceId : e11 * this._index.pageSize + i8,
        obb: I.fromJSON(t13.obb),
        obbInRenderSR: new I(),
        firstChild: t13.firstChild,
        childCount: t13.childCount,
        vertexCount: t13.vertexCount ?? t13.pointCount,
        lodThreshold: t13.lodThreshold ?? t13.effectiveArea
      }))),
      abortController: t11
    };
  }
  _updateWorkQueues() {
    if (!this._updateViewNeeded) return false;
    const e11 = this.view.quality;
    let t11 = this.inverseDensity / this._lodFactor * e11;
    const i7 = this.maximumPointCount * this._lodFactor * e11;
    let r13 = this._computeNodesForMinimumDensity(t11), s6 = this._computePointCount(r13), o7 = Math.sqrt(s6 / (0.75 * i7));
    for (; s6 > i7; ) t11 *= o7, r13 = this._computeNodesForMinimumDensity(t11), s6 = this._computePointCount(r13), o7 = Math.sqrt(2);
    return this._displayNodes(r13), this._updateViewNeeded = false, this._updateLoading(), true;
  }
  _computePointCount(e11) {
    let t11 = 0;
    for (let i7 = 0; i7 < e11.length; i7++) {
      const r13 = this._index.getNode(e11[i7]);
      r13 && (t11 += r13.vertexCount);
    }
    return t11;
  }
  _isRootNodeVisible() {
    let e11 = false;
    return this._traverseVisible({
      frustum: this.view.state.contentCamera.frustum,
      clippingBox: this._clippingBox
    }, {
      predicate: (t11, i7, r13) => (e11 = r13, false),
      pageMiss: () => {
      }
    }), e11;
  }
  _computeNodesForMinimumDensity(e11) {
    const t11 = this.view.state.contentCamera, i7 = t11.frustum, r13 = this._clippingBox, s6 = t11.viewForward, o7 = P2(s6, t11.eye), n5 = _2(s6, -o7, he), a6 = t11.perScreenPixelRatio / 2, d5 = e11 * e11, l5 = this._nodeIdArray;
    l5.length = 0;
    const h6 = (e12) => l5.push(e12);
    return this._traverseVisible({
      frustum: i7,
      clippingBox: r13
    }, {
      predicate: (e12, t12, i8) => {
        if (!i8) return false;
        if (0 === t12.childCount) return h6(e12), false;
        const r14 = this._index.getRenderObb(e12);
        return !(this._computeAveragePixelArea(r14, t12.lodThreshold, t12.vertexCount, n5, a6) <= d5) || (h6(e12), false);
      },
      pageMiss: (e12, t12) => {
        h6(e12), this._indexQueue.includes(t12) || this._indexQueue.push(t12);
      }
    }), l5;
  }
  _computeAveragePixelArea(e11, t11, i7, r13, s6) {
    const o7 = 1e-7, n5 = Math.max(o7, e11.minimumDistancePlane(r13));
    return t11 / (n5 * n5) / (4 * s6 * s6) / i7;
  }
  _loadNode(e11, t11) {
    try {
      return this._loadNodeAsync(e11, t11);
    } catch (i7) {
      throw b(i7) || n.getLogger(this).error(i7), i7;
    }
  }
  _loadAdditionalUserAttributes(e11, i7, r13) {
    return __async(this, null, function* () {
      const s6 = this.layer.outFields;
      if (!s6) return [];
      const o7 = x(this.layer.fieldsIndex, s6), n5 = new Set(e11.map((e12) => null != e12 ? e12.name : null)), a6 = this.layer.attributeStorageInfo, d5 = [];
      for (const t11 of o7) {
        if (n5.has(t11)) continue;
        const e12 = u6(a6, t11);
        e12 && d5.push(i7(e12));
      }
      const l5 = yield g(d5);
      return s(r13), l5.filter(O);
    });
  }
  _loadNodeAsync(e11, t11) {
    return __async(this, null, function* () {
      const i7 = this._index.getNode(e11), r13 = t10(this.layer), s6 = e9(this.layer), o7 = i7.resourceId, n5 = (e12) => __async(this, null, function* () {
        if (!e12) return null;
        if (e12.useElevation) return {
          attributeInfo: e12,
          buffer: null
        };
        const i8 = yield this._loadAttribute(o7, e12, t11);
        return null != i8 ? {
          attributeInfo: e12,
          buffer: i8
        } : null;
      });
      return this._idleQueue.push(() => __async(this, null, function* () {
        const i8 = this._loadGeometry(o7, t11), {
          primaryAttribute: a6,
          modulationAttribute: d5
        } = r13, l5 = n5(a6), h6 = n5(d5), p3 = s6.map((e12) => e12.attributeInfo), _5 = p3.map((e12) => n5(e12)), c5 = this._loadAdditionalUserAttributes([a6, d5, ...p3], n5, t11), [m2, g5, f3, y4, b3] = yield Promise.all([i8, l5, h6, Promise.all(_5), c5]);
        s(t11);
        const w = {
          geometryBuffer: m2,
          primaryAttributeData: g5,
          modulationAttributeData: f3,
          filterAttributesData: y4,
          userAttributesData: b3,
          schema: this.layer.store.defaultGeometrySchema,
          rendererInfo: r13,
          filterInfo: s6,
          obbData: this._index.getRenderObb(e11).data,
          elevationOffset: this._elevationOffset,
          inSR: this.layer.spatialReference.toJSON(),
          outSR: this.view.renderCoordsHelper.spatialReference.toJSON()
        };
        return this._worker.invoke(w, t11);
      }), t11);
    });
  }
  _loadGeometry(e11, t11) {
    return __async(this, null, function* () {
      return this._requestData(`${this.baseUrl}/nodes/${e11}/geometries/0`, t11);
    });
  }
  _loadAttribute(e11, t11, i7) {
    return __async(this, null, function* () {
      if (!t11?.storageInfo) return null;
      const r13 = t11.storageInfo.key;
      return this._requestData(`${this.baseUrl}/nodes/${e11}/attributes/${r13}`, i7);
    });
  }
  _requestNodePage(e11, t11) {
    const i7 = __spreadProps(__spreadValues({
      f: "json"
    }, this.layer.customParameters), {
      token: this.layer.apiKey
    });
    return this._indexRequester.request(e11, "json", {
      query: i7,
      signal: t11
    });
  }
  _requestData(e11, t11) {
    return this._dataRequester.request(e11, "binary", {
      query: __spreadProps(__spreadValues({}, this.layer.customParameters), {
        token: this.layer.apiKey
      }),
      signal: t11
    });
  }
  _removeFromRenderer(e11) {
    if (this._renderedNodes.has(e11)) {
      const t11 = this._renderer.removeNode(e11);
      this._renderedNodes.delete(e11), this._memCache.put(t11.id.toString(), t11, _e(t11));
    }
  }
  _addToRenderer(e11) {
    this._renderedNodes.has(e11.id) || (this._renderedNodes.add(e11.id), this._renderer.addNode(e11));
  }
  _setupRendererData(e11, t11) {
    const i7 = this._index.getNode(e11), r13 = Math.sqrt(i7.lodThreshold / i7.vertexCount), s6 = this._index.getRenderObb(e11);
    if (Q(t11)) return t11.splatSize = r13, t11.obb = s6, r2(t11.origin, t11.obb.center), t11;
    const o7 = I.fromData(t11.obbData), a6 = o7.halfSize, d5 = s6.halfSize, l5 = 0.01 * Math.max(d5[0], d5[1], d5[2]);
    if (a6[0] > d5[0] + l5 || a6[1] > d5[1] + l5 || a6[2] > d5[2] + l5) {
      if (this._maxLoggedBoxWarnings > 0) {
        const t12 = (e12) => `[${e12.halfSize[0]}, ${e12.halfSize[1]}, ${e12.halfSize[2]}]`;
        n.getLogger(this).warn(`Node ${e11} reported bounding box too small. got ${t12(s6)} but points cover ${t12(o7)}`), 0 == --this._maxLoggedBoxWarnings && n.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.");
      }
      this._index.setRenderObb(e11, o7);
    }
    return new G2(e11, r13, t3(s6.center), s6, 0 === i7.childCount, t11.points, t11.rgb, t11.attributes, t11.pointIdFilterMap);
  }
  get usedMemory() {
    let e11 = 0;
    return this._renderer.forEachNode((t11) => {
      e11 += ce, e11 += A(t11.coordinates);
      for (const i7 of t11.attributes) {
        const t12 = i7.values;
        t(t12.buffer) && (e11 += A(t12));
      }
    }), e11;
  }
  get unloadedMemory() {
    const e11 = this._renderedNodes.size;
    if (e11 < 4) return 0;
    const t11 = [...this._renderedNodes].reduce((e12, t12) => e12 + this._index.getNode(t12).vertexCount);
    let i7 = this._loadingNodes.size;
    for (let r13 = 0; r13 < this._workQueue.length; r13++) i7 += this._workQueue[r13].load.length, i7 -= this._workQueue[r13].remove.length;
    if (i7 < 0) return 0;
    return i7 * t11 / e11 * ((this.usedMemory - e11 * ce) / t11) + i7 * ce;
  }
  get performanceInfo() {
    return new e8(this.usedMemory, this._renderedNodes.size, [...this._renderedNodes].reduce((e11, t11) => e11 + this._index.getNode(t11).vertexCount, 0), this.maximumPointCount, new o3(this._loadingNodes.size, this._indexQueue.length, this._workQueue.length, this._idleQueue.length));
  }
  get test() {
  }
};
e3([y()], ue.prototype, "layer", void 0), e3([y()], ue.prototype, "baseUrl", null), e3([y()], ue.prototype, "pointScale", null), e3([y()], ue.prototype, "useRealWorldSymbolSizes", null), e3([y()], ue.prototype, "pointSize", null), e3([y()], ue.prototype, "inverseDensity", null), e3([y()], ue.prototype, "maximumPointCount", void 0), e3([y({
  readOnly: true
})], ue.prototype, "availableFields", null), e3([y({
  readOnly: true
})], ue.prototype, "_clippingBox", null), e3([y({
  readOnly: true
})], ue.prototype, "_elevationOffset", null), e3([y({
  type: Boolean
})], ue.prototype, "slicePlaneEnabled", void 0), e3([y()], ue.prototype, "updating", void 0), e3([y(t8)], ue.prototype, "updatingProgress", void 0), e3([y({
  readOnly: true
})], ue.prototype, "updatingProgressValue", null), e3([y({
  readOnly: true
})], ue.prototype, "visibleAtCurrentScale", null), ue = e3([a("esri.views.3d.layers.PointCloudLayerView3D")], ue);
var pe = ue;
function _e(e11) {
  return 5 * e11.coordinates.length + 128;
}
var ce = 160;
function me(e11) {
  return (t11) => e11.immediate.schedule(t11);
}
export {
  pe as default
};
//# sourceMappingURL=PointCloudLayerView3D-KXZOR7B3.js.map
