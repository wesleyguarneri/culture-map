import { createRequire } from 'module';const require = createRequire(import.meta.url);
import {
  E,
  M,
  T,
  ae
} from "./chunk-AEKZSVKX.js";
import "./chunk-PGTI2BU4.js";
import {
  R
} from "./chunk-BHMMT4R2.js";
import "./chunk-HP5U6UA4.js";
import "./chunk-6A4CZ4JY.js";
import "./chunk-BYXMUOMW.js";
import "./chunk-YEWOBDQB.js";
import "./chunk-FWEBARAB.js";
import "./chunk-RHUWRAPT.js";
import "./chunk-VY63YX6I.js";
import "./chunk-EXKCGLRO.js";
import "./chunk-WRLGLGM6.js";
import "./chunk-47DYJR3W.js";
import "./chunk-NE35ZNG6.js";
import "./chunk-ZLSZAC2I.js";
import "./chunk-QRWQ6QBB.js";
import "./chunk-TFW6WS6R.js";
import "./chunk-X5QZGB37.js";
import "./chunk-T5C2TZNO.js";
import "./chunk-AOGKNBDG.js";
import "./chunk-F4FQ67JP.js";
import "./chunk-FDI2X6GO.js";
import "./chunk-3XHDZQO5.js";
import "./chunk-2BLQXT54.js";
import "./chunk-JSWVKNBA.js";
import "./chunk-LL33G4DK.js";
import "./chunk-CILHMGNK.js";
import "./chunk-2BOKEEZV.js";
import "./chunk-XUSZNRTW.js";
import "./chunk-W26QF64E.js";
import "./chunk-D3XX7CQS.js";
import "./chunk-Q6OCJ3NG.js";
import "./chunk-DD6UQHSS.js";
import "./chunk-FALQTRQL.js";
import "./chunk-GGTDLTZW.js";
import "./chunk-2W7YKBRA.js";
import "./chunk-GLFGRGCP.js";
import "./chunk-VFQA3B5S.js";
import "./chunk-NOH3NLJ5.js";
import "./chunk-LX5BT6XP.js";
import "./chunk-PLGJMWC5.js";
import "./chunk-UGFQYEND.js";
import {
  e as e3
} from "./chunk-XC5RDNAY.js";
import "./chunk-KXVPQVTB.js";
import "./chunk-ARN5GJBK.js";
import "./chunk-MPLS4PY6.js";
import "./chunk-AGBPYPP3.js";
import "./chunk-VMZV7772.js";
import "./chunk-3FR2T2I2.js";
import "./chunk-LOZRWPGI.js";
import "./chunk-GZ64OOAB.js";
import "./chunk-WR2NVDOI.js";
import "./chunk-EPLJRYUV.js";
import "./chunk-VYRCS5VR.js";
import "./chunk-OOK3QTWF.js";
import {
  l as l2
} from "./chunk-PQUZDC3L.js";
import "./chunk-UUQ5O7GK.js";
import "./chunk-6XY35LS7.js";
import "./chunk-JTDKNK44.js";
import "./chunk-RR7OQLEK.js";
import "./chunk-NAG6YX7T.js";
import "./chunk-WFNAKG2H.js";
import "./chunk-EKHRAAS6.js";
import "./chunk-IEB4ZCRH.js";
import "./chunk-7QOUHKW5.js";
import "./chunk-NHYYZMJR.js";
import "./chunk-WVSTX2NW.js";
import "./chunk-ORYC4PVJ.js";
import "./chunk-DXIKKLD7.js";
import "./chunk-VQNXE43R.js";
import "./chunk-VZ37C3ID.js";
import "./chunk-5R3HARKC.js";
import "./chunk-BKSTWG4S.js";
import "./chunk-FSG7HOZQ.js";
import "./chunk-Q5TIVVER.js";
import "./chunk-ZPMUEGLK.js";
import "./chunk-GNFDYYU3.js";
import "./chunk-X36BR2QB.js";
import "./chunk-RGG3YJQA.js";
import "./chunk-GBJYL7OX.js";
import "./chunk-GHKVDSKU.js";
import "./chunk-NVOJILW6.js";
import "./chunk-KYPTWEOO.js";
import "./chunk-WVFB3H4O.js";
import "./chunk-C7BQE556.js";
import "./chunk-ZREJ3Y2F.js";
import "./chunk-IR6CVPPC.js";
import "./chunk-BBUQOCRA.js";
import "./chunk-YBUJLIWZ.js";
import "./chunk-DL2B6IFJ.js";
import "./chunk-VOOO6FU5.js";
import "./chunk-IUPJR3FF.js";
import "./chunk-TGZW6QWO.js";
import "./chunk-OYIDHTXG.js";
import "./chunk-KUBMHTYA.js";
import "./chunk-NU4K6CTR.js";
import "./chunk-42ZAWY2C.js";
import "./chunk-TVHVZK5G.js";
import "./chunk-P2MUOE6G.js";
import "./chunk-CRYYUS4E.js";
import "./chunk-V33IUWAS.js";
import "./chunk-E5NWFBZG.js";
import "./chunk-FP37456K.js";
import "./chunk-VSQZQLTQ.js";
import "./chunk-K43CZ3M5.js";
import "./chunk-6EIBUVMG.js";
import {
  j
} from "./chunk-BD24XM4D.js";
import "./chunk-YCXNHEGB.js";
import "./chunk-CSATD3VX.js";
import "./chunk-NXXQ35YM.js";
import "./chunk-3BXPVUY5.js";
import "./chunk-LM3JDV4W.js";
import "./chunk-34V2CLL5.js";
import "./chunk-CXNERL22.js";
import "./chunk-7V4JSBFA.js";
import {
  f as f2
} from "./chunk-REIMIECM.js";
import {
  l
} from "./chunk-EO2EW5KR.js";
import "./chunk-JEFPXTYT.js";
import "./chunk-MVS2BECH.js";
import {
  t as t2
} from "./chunk-UZ7IOCF3.js";
import {
  b
} from "./chunk-OS542PQQ.js";
import {
  p as p2
} from "./chunk-3B5GODXR.js";
import "./chunk-NKXXHQDD.js";
import {
  S
} from "./chunk-7TBQUMV3.js";
import {
  f
} from "./chunk-TPLUZX3A.js";
import "./chunk-BGLJ2FAH.js";
import "./chunk-2EJFYNM7.js";
import "./chunk-DC5LRNPY.js";
import "./chunk-ASCK5HJ5.js";
import "./chunk-5X5U7R6O.js";
import "./chunk-XNLAOXPY.js";
import "./chunk-ZT7V2AVD.js";
import "./chunk-C2OXE4NQ.js";
import "./chunk-KOI252FF.js";
import "./chunk-I2TVVMQ6.js";
import "./chunk-5EGQYY2H.js";
import "./chunk-JKPUNUQA.js";
import "./chunk-SR7PRON4.js";
import "./chunk-HGHPYGKP.js";
import "./chunk-4DSGTDZJ.js";
import "./chunk-VYTPFEL2.js";
import "./chunk-RLGDH6IY.js";
import "./chunk-MRPCXIVS.js";
import "./chunk-YTKVV2Y3.js";
import "./chunk-GCVQXAS4.js";
import "./chunk-UFQD6AL4.js";
import {
  n as n3
} from "./chunk-EGBDRLCX.js";
import "./chunk-THZPD5CT.js";
import "./chunk-OBCA6CWH.js";
import "./chunk-2JI245BP.js";
import "./chunk-CBOFHWPI.js";
import "./chunk-ABIG6PT5.js";
import "./chunk-ZEZ3LI2L.js";
import "./chunk-N34BRXVM.js";
import "./chunk-KETDH2J4.js";
import "./chunk-7QV7DHWN.js";
import "./chunk-4L4Y34YK.js";
import {
  m,
  p
} from "./chunk-BXONKQKI.js";
import "./chunk-2HDBQXAR.js";
import "./chunk-RNF7VOCU.js";
import "./chunk-TIRJMGGG.js";
import "./chunk-ZDRQSPB6.js";
import {
  o
} from "./chunk-DCXDXGAR.js";
import {
  r as r2
} from "./chunk-BCCDYCTQ.js";
import "./chunk-AYL3HQHD.js";
import "./chunk-66YQWHHE.js";
import "./chunk-QGBMZIP4.js";
import "./chunk-AOEBZVTA.js";
import "./chunk-2OZSYJDX.js";
import "./chunk-MZM4INJV.js";
import "./chunk-J4GMQHGL.js";
import "./chunk-MHPE4SZA.js";
import "./chunk-6SSA7P3A.js";
import "./chunk-FQBTLEUI.js";
import "./chunk-GS7Y3YOG.js";
import "./chunk-Y2HYKTTT.js";
import {
  V as V2,
  Y
} from "./chunk-XLEC46FY.js";
import "./chunk-4AZPIP7K.js";
import "./chunk-G73HQZEL.js";
import "./chunk-LZSLQ24Q.js";
import {
  V
} from "./chunk-U3RHUXYK.js";
import "./chunk-7DBI6LQG.js";
import "./chunk-AUUN7RFQ.js";
import "./chunk-JAMSDYD6.js";
import "./chunk-PH6NPTP7.js";
import {
  e as e2
} from "./chunk-NUICEVIH.js";
import {
  e,
  n2,
  t3 as t
} from "./chunk-NXK752PZ.js";
import {
  y
} from "./chunk-UVNLCXWD.js";
import "./chunk-PNUA7JOS.js";
import "./chunk-OR2FKGUM.js";
import {
  a3 as a2,
  r2 as r
} from "./chunk-UDMPWVPF.js";
import "./chunk-XJNKCEWL.js";
import {
  a
} from "./chunk-AIZ3T7E3.js";
import "./chunk-6UEMNP3E.js";
import "./chunk-6WGE3IUL.js";
import "./chunk-MLYB2YW4.js";
import {
  n2 as n,
  s2 as s
} from "./chunk-6JFGZTLU.js";
import "./chunk-2ZJE6ZFX.js";
import {
  __async
} from "./chunk-XBPEBUD5.js";

// ../../../node_modules/@arcgis/core/layers/KnowledgeGraphLayer.js
var E2 = class extends l(t2(f2(l2(b(j(S(e3(f)))))))) {
  constructor(e4) {
    super(e4), this._graphTypeLookup = /* @__PURE__ */ new Map(), this._namedTypesModified = false, this.dataManager = null, this.definitionSetMap = null, this.knowledgeGraph = null, this.layers = new (V.ofType(ae))(), this.memberEntityTypes = null, this.memberRelationshipTypes = null, this.operationalLayerType = "KnowledgeGraphLayer", this.sublayerIdsCache = /* @__PURE__ */ new Map(), this.tables = new (V.ofType(ae))(), this.type = "knowledge-graph", this.url = null;
  }
  load(e4) {
    return this.addResolvingPromise(this._doLoad(e4)), Promise.resolve(this);
  }
  _doLoad(e4) {
    return __async(this, null, function* () {
      try {
        yield this.loadFromPortal({
          supportedTypes: ["Knowledge Graph Layer"]
        }, e4);
      } catch (t3) {
        a(t3);
      }
      yield this._fetchMetadata(), yield this._initializeLayerProperties(), this.loadLayerAssumingLocalCache();
    });
  }
  _fetchMetadata() {
    return __async(this, null, function* () {
      if (!this.url) throw new s("knowledge-graph:missing-url", "KnowledgeGraphLayer must be created with a url");
      const e4 = yield R(this.url);
      this.knowledgeGraph = e4, this._forEachGraphType((e5) => {
        e5.name && this._graphTypeLookup.set(e5.name, e5);
      });
    });
  }
  _initializeLayerProperties() {
    return __async(this, null, function* () {
      this.originIdOf("inclusionModeDefinition") === e.USER ? this._validateInclusionModeDefinition() : yield this._initializeInclusionModeDefinition(), this._setMemberTypes(), this.dataManager = new M({
        knowledgeGraph: this.knowledgeGraph,
        inclusionModeDefinition: this.inclusionModeDefinition
      });
    });
  }
  _initializeInclusionModeDefinition() {
    return __async(this, null, function* () {
      const e4 = this.definitionSetMap ? yield T(this.definitionSetMap, true) : {
        generateAllSublayers: true,
        namedTypeDefinitions: /* @__PURE__ */ new Map()
      };
      [...this.layers.toArray(), ...this.tables.toArray()].forEach((t3) => {
        const i = this._graphTypeLookup.get(t3.graphTypeName);
        i && !e4.namedTypeDefinitions.has(i.name) && e4.namedTypeDefinitions.set(i.name, {
          useAllData: true
        });
      }), this.setAtOrigin("inclusionModeDefinition", e4, t(this.originIdOf("definitionSetMap")));
    });
  }
  _validateInclusionModeDefinition() {
    const {
      inclusionModeDefinition: e4
    } = this;
    if (!e4) return;
    const {
      namedTypeDefinitions: t3
    } = e4;
    if (t3?.size > 0) t3.forEach((e5, i) => {
      const s2 = this._graphTypeLookup.get(i);
      if (!s2) return n.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`), void t3.delete(i);
      "relationship" !== s2.type && "entity" !== s2.type && (n.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't properly modeled and will be removed`), t3.delete(i));
    });
    else if (!e4.generateAllSublayers) throw new s("knowledge-graph:composite-layer-constructor", "If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");
  }
  _setMemberTypes() {
    let e4 = [], t3 = [];
    const {
      inclusionModeDefinition: i
    } = this, o2 = i?.namedTypeDefinitions;
    !i || i.generateAllSublayers ? (e4 = this.knowledgeGraph.dataModel?.entityTypes ?? [], t3 = this.knowledgeGraph.dataModel?.relationshipTypes ?? []) : o2 && o2.size > 0 && o2.forEach((i2, o3) => {
      const s2 = this._graphTypeLookup.get(o3);
      switch (s2?.type) {
        case "relationship":
          t3.push(s2);
          break;
        case "entity":
          e4.push(s2);
      }
    }), this.memberEntityTypes = e4, this.memberRelationshipTypes = t3;
  }
  _forEachGraphType(e4) {
    [...this.knowledgeGraph.dataModel?.entityTypes ?? [], ...this.knowledgeGraph.dataModel?.relationshipTypes ?? []].forEach((t3) => {
      e4(t3);
    });
  }
  _refreshNamedTypes() {
    this._namedTypesModified = true;
    for (const e4 of this.layers) e4.emit("refresh", {
      dataChanged: true
    });
    for (const e4 of this.tables) e4.emit("refresh", {
      dataChanged: true
    });
  }
  _handleNewRecords(e4) {
    return __async(this, null, function* () {
      const t3 = [];
      this.dataManager.addToLayer(e4);
      for (const i of e4) this.sublayerIdsCache.has(i.typeName) || (this.sublayerIdsCache.set(i.typeName, /* @__PURE__ */ new Set()), t3.push(i.typeName)), this.sublayerIdsCache.get(i.typeName).add(i.id);
      for (const i of t3) {
        const e5 = this._graphTypeLookup.get(i);
        if (!e5) continue;
        this._addSublayer(e5).title = i, "entity" === e5.type ? this.dataManager.entityTypeNames.add(i) : this.dataManager.relationshipTypeNames.add(i), this.dataManager.sublayerCaches.set(i, /* @__PURE__ */ new Map());
      }
      this._refreshNamedTypes();
    });
  }
  _createSublayers(e4, t3, i) {
    e4.forEach((e5) => {
      const o2 = this._createSublayer(e5);
      i(o2) && t3.push(o2), this._updateSublayerCaches(e5);
    });
  }
  _addSublayer(e4) {
    const t3 = this._createSublayer(e4);
    return t3.geometryType ? this.layers.push(t3) : this.tables.push(t3), t3;
  }
  _createSublayer(e4) {
    return new ae({
      objectType: e4,
      parentCompositeLayer: this,
      graphType: e4.type,
      title: e4.name
    });
  }
  _updateSublayers(e4, t3) {
    t3.forEach((t4) => {
      t4.parentCompositeLayer = this;
      const i = e4.find((e5) => e5.type === t4.graphType && e5.name === t4.graphTypeName);
      i && (t4.objectType = i, t4.read({
        title: i.name
      }, {
        origin: "service"
      }), this._updateSublayerCaches(i));
    });
  }
  _updateSublayerCaches(e4) {
    const t3 = this.dataManager.sublayerCaches;
    t3.has(e4.name) || t3.set(e4.name, /* @__PURE__ */ new Map());
  }
  _saveUrlAsNewResource(e4, t3, i, o2) {
    e4[t3] = "<pending>", i.pendingOperations.push(I(this.inclusionModeDefinition).then((s2) => {
      const r3 = O(o2);
      e4[t3] = r3.itemRelativeUrl, i.toAdd.push({
        resource: r3,
        content: {
          type: "blob",
          blob: s2
        },
        compress: false,
        finish: (e5) => {
          this.definitionSetMap = e5.url;
        }
      });
    }));
  }
  _displaysAllRecords(e4) {
    for (const [, {
      useAllData: t3
    }] of e4.namedTypeDefinitions) if (!t3) return false;
    return true;
  }
  readDefinitionSetMap(e4, t3, i) {
    return p(e4, i);
  }
  writeDefinitionSetMap(e4, t3, i, o2) {
    const s2 = o2?.portalItem, r3 = o2?.resources, a3 = n2(o2?.origin);
    if (!s2 || !r3 || null == a3) return void (e4 && (t3[i] = m(e4, o2)));
    const {
      inclusionModeDefinition: p3
    } = this;
    if (!p3 || this._displaysAllRecords(p3)) return void (this.definitionSetMap = null);
    const l3 = this.originIdOf("inclusionModeDefinition");
    if (l3 === e.USER || this._namedTypesModified || a3 < l3) this._saveUrlAsNewResource(t3, i, r3, s2);
    else if (a3 === l3 && e4) {
      const a4 = m(e4, o2);
      Y(a4) ? this._saveUrlAsNewResource(t3, i, r3, s2) : t3[i] = a4;
    }
  }
  set inclusionModeDefinition(e4) {
    "loaded" !== this.loadStatus && "failed" !== this.loadStatus ? this._set("inclusionModeDefinition", e4) : n.getLogger(this).error("#inclusionModeDefinition", "inclusionModeDefinition cannot be changed after the layer is loaded.");
  }
  loadLayerAssumingLocalCache() {
    const e4 = [...this.memberEntityTypes, ...this.memberRelationshipTypes];
    this.originIdOf("layers") === e.DEFAULTS ? this._createSublayers(e4, this.layers, (e5) => !!e5.geometryType) : this._updateSublayers(e4, this.layers), this.originIdOf("tables") === e.DEFAULTS ? this._createSublayers(e4, this.tables, (e5) => !e5.geometryType) : this._updateSublayers(e4, this.tables), this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e5, t3) => {
      const i = r(this.sublayerIdsCache, t3, () => /* @__PURE__ */ new Set());
      e5.members?.forEach((e6) => {
        i.add(e6.id);
      });
    });
  }
  addRecords(e4) {
    return __async(this, null, function* () {
      yield this._handleNewRecords(e4);
    });
  }
  removeRecords(e4) {
    return __async(this, null, function* () {
      const t3 = [];
      for (const i of e4) false === this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(i.typeName)?.useAllData && this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(i.typeName)?.members?.has(i.id) && t3.push(i);
      this.dataManager.removeFromLayer(t3);
      for (const i of t3) this.sublayerIdsCache.get(i.typeName)?.delete(i.id);
      return this._refreshNamedTypes(), t3;
    });
  }
};
e2([y()], E2.prototype, "dataManager", void 0), e2([y({
  json: {
    write: {
      ignoreOrigin: true,
      writerEnsuresNonNull: true
    }
  }
})], E2.prototype, "definitionSetMap", void 0), e2([o("definitionSetMap")], E2.prototype, "readDefinitionSetMap", null), e2([r2("definitionSetMap")], E2.prototype, "writeDefinitionSetMap", null), e2([y()], E2.prototype, "inclusionModeDefinition", null), e2([y()], E2.prototype, "knowledgeGraph", void 0), e2([y({
  type: V.ofType(ae),
  json: {
    write: {
      ignoreOrigin: true
    }
  }
})], E2.prototype, "layers", void 0), e2([y()], E2.prototype, "memberEntityTypes", void 0), e2([y()], E2.prototype, "memberRelationshipTypes", void 0), e2([y({
  type: ["KnowledgeGraphLayer"]
})], E2.prototype, "operationalLayerType", void 0), e2([y()], E2.prototype, "sublayerIdsCache", void 0), e2([y({
  type: V.ofType(ae),
  json: {
    write: {
      ignoreOrigin: true
    }
  }
})], E2.prototype, "tables", void 0), e2([y({
  json: {
    read: false
  }
})], E2.prototype, "type", void 0), e2([y(p2)], E2.prototype, "url", void 0), E2 = e2([a2("esri.layers.KnowledgeGraphLayer")], E2);
var R2 = E2;
function I(e4) {
  return __async(this, null, function* () {
    const t3 = yield E(e4);
    return new Blob([t3], {
      type: "application/x-protobuf"
    });
  });
}
function O(e4) {
  const t3 = `definitionSetMap-${n3()}.dat`, i = V2("knowledgeGraphLayer", t3);
  return e4.resourceFromPath(i);
}
export {
  R2 as default
};
//# sourceMappingURL=KnowledgeGraphLayer-ORKE5NNZ.js.map
