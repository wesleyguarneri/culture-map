{
  "version": 3,
  "sources": ["../../../../../../node_modules/@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js", "../../../../../../node_modules/@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nclass t {\n  constructor(t = 15e3, e = 5e3) {\n    this._timer = null, this._cachedBlocks = new Map(), this._size = -1, this._duration = t, this._interval = Math.min(t, e);\n  }\n  decreaseRefCount(t, e) {\n    const s = t + \"/\" + e,\n      r = this._cachedBlocks;\n    if (r.has(s)) {\n      const t = r.get(s);\n      return t.refCount--, t.refCount <= 0 && (r.delete(s), t.controller && t.controller.abort()), t.refCount;\n    }\n    return 0;\n  }\n  getBlock(t, e) {\n    const s = t + \"/\" + e,\n      r = this._cachedBlocks;\n    if (r.has(s)) {\n      const t = r.get(s);\n      return t.ts = Date.now(), t.refCount++, r.delete(s), r.set(s, t), t.block;\n    }\n    return null;\n  }\n  putBlock(t, e, s, r) {\n    const i = this._cachedBlocks,\n      c = t + \"/\" + e;\n    if (i.has(c)) {\n      const t = i.get(c);\n      t.ts = Date.now(), t.refCount++;\n    } else i.set(c, {\n      block: s,\n      ts: Date.now(),\n      refCount: 1,\n      controller: r\n    });\n    this._trim(), this._updateTimer();\n  }\n  deleteBlock(t, e) {\n    const s = this._cachedBlocks,\n      r = t + \"/\" + e;\n    s.has(r) && s.delete(r);\n  }\n  updateMaxSize(t) {\n    this._size = t, this._trim();\n  }\n  empty() {\n    this._cachedBlocks.clear(), this._clearTimer();\n  }\n  getCurrentSize() {\n    return this._cachedBlocks.size;\n  }\n  _updateTimer() {\n    if (null != this._timer) return;\n    const t = this._cachedBlocks;\n    this._timer = setInterval(() => {\n      const e = Array.from(t),\n        s = Date.now();\n      for (let r = 0; r < e.length && e[r][1].ts <= s - this._duration; r++) t.delete(e[r][0]);\n      0 === t.size && this._clearTimer();\n    }, this._interval);\n  }\n  _trim() {\n    const t = this._cachedBlocks;\n    if (-1 === this._size || this._size >= t.size) return;\n    const e = Array.from(t);\n    for (let s = 0; s < e.length - this._size; s++) t.delete(e[s][0]);\n  }\n  _clearTimer() {\n    null != this._timer && (clearInterval(this._timer), this._timer = null);\n  }\n}\nexport { t as default };", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport \"../../../geometry.js\";\nimport e from \"./EphemeralBlockCache.js\";\nimport { projectExtent as t, projectResolution as n, snapPyramid as o } from \"../rasterFunctions/rasterProjectionHelper.js\";\nimport l from \"../../../geometry/Point.js\";\nconst r = new Map(),\n  c = new e();\nfunction i(e, t) {\n  return null == t ? e : `${e}?sliceId=${t}`;\n}\nfunction u(e, t) {\n  const n = {\n      extent: null,\n      rasterInfo: t,\n      cache: new Map()\n    },\n    o = r.get(e);\n  return o ? (o.push(n), o.length - 1) : (r.set(e, [n]), 0);\n}\nfunction a(e, t) {\n  const n = r.get(e);\n  n && (n[t] = null, n.some(e => null != e) || r.delete(e));\n}\nfunction f(e) {\n  r.delete(e);\n}\nfunction s(e, t, n) {\n  const o = r.get(e);\n  if (!o) return null == t ? c.decreaseRefCount(e, n) : 0;\n  if (null == t || null == o[t]) return c.decreaseRefCount(e, n);\n  const l = o[t]?.cache,\n    i = l?.get(n);\n  if (l && i) {\n    if (i.refCount--, 0 === i.refCount) {\n      l.delete(n);\n      for (let e = 0; e < o.length; e++) o[e]?.cache.delete(n);\n      i.controller && i.controller.abort();\n    }\n    return i.refCount;\n  }\n  return 0;\n}\nfunction m(e, t, n) {\n  const o = r.get(e);\n  if (!o) return null == t ? c.getBlock(e, n) : null;\n  if (null == t || null == o[t]) {\n    for (let e = 0; e < o.length; e++) {\n      const t = o[e]?.cache.get(n);\n      if (t) return t.refCount++, t.block;\n    }\n    return c.getBlock(e, n);\n  }\n  const l = o[t]?.cache.get(n);\n  if (l) return l.refCount++, l.block;\n  for (let r = 0; r < o.length; r++) {\n    if (r === t || !o[r]) continue;\n    const e = o[r]?.cache,\n      l = e?.get(n);\n    if (e && l) return l.refCount++, e.set(n, l), l.block;\n  }\n  return null;\n}\nfunction x(e, t, n, o, l = null) {\n  const i = r.get(e);\n  if (!i) return void (null == t && c.putBlock(e, n, o, l));\n  if (null == t || null == i[t]) return void c.putBlock(e, n, o, l);\n  const u = {\n    refCount: 1,\n    block: o,\n    isResolved: !1,\n    isRejected: !1,\n    controller: l\n  };\n  o.then(() => u.isResolved = !0).catch(() => u.isRejected = !0), i[t]?.cache.set(n, u);\n}\nfunction h(e, t, n) {\n  const o = r.get(e);\n  o ? null != t && null != o[t] ? o[t]?.cache.delete(n) : c.deleteBlock(e, n) : null == t && c.deleteBlock(e, n);\n}\nfunction d(e, t) {\n  const n = r.get(e);\n  return n ? n[t] ?? null : null;\n}\nfunction g(e, r, c, i, u, a, f = null) {\n  const s = d(e, r);\n  if (!s) return;\n  const m = s.extent,\n    {\n      cache: x,\n      rasterInfo: h\n    } = s;\n  if (m && m.xmin === c.xmin && m.xmax === c.xmax && m.ymin === c.ymin && m.ymax === c.ymax) return;\n  i = i ?? 0;\n  const g = c.clone().normalize(),\n    {\n      spatialReference: y,\n      transform: p\n    } = h,\n    k = new Set();\n  for (let d = 0; d < g.length; d++) {\n    const e = g[d];\n    if (e.xmax - e.xmin <= i || e.ymax - e.ymin <= i) continue;\n    let r = t(e, y, f);\n    null != p && (r = p.inverseTransform(r));\n    const c = new l({\n      x: i,\n      y: i,\n      spatialReference: e.spatialReference\n    });\n    if (null == u && !(u = n(c, y, e, f))) return;\n    const {\n      pyramidLevel: s,\n      pyramidResolution: m,\n      excessiveReading: x\n    } = o(u, h, a || \"closest\");\n    if (x) return;\n    const {\n        storageInfo: M\n      } = h,\n      {\n        origin: R\n      } = M,\n      C = {\n        x: Math.max(0, Math.floor((r.xmin - R.x) / m.x)),\n        y: Math.max(0, Math.floor((R.y - r.ymax) / m.y))\n      },\n      B = Math.ceil((r.xmax - r.xmin) / m.x - .1),\n      j = Math.ceil((r.ymax - r.ymin) / m.y - .1),\n      v = s > 0 ? M.pyramidBlockWidth : M.blockWidth,\n      b = s > 0 ? M.pyramidBlockHeight : M.blockHeight,\n      w = 1,\n      $ = Math.max(0, Math.floor(C.x / v) - w),\n      I = Math.max(0, Math.floor(C.y / b) - w),\n      H = Math.floor((C.x + B - 1) / v) + w,\n      E = Math.floor((C.y + j - 1) / b) + w;\n    for (let t = I; t <= E; t++) for (let e = $; e <= H; e++) k.add(`${s}/${t}/${e}`);\n  }\n  x.forEach((e, t) => {\n    if (!k.has(t)) {\n      const e = x.get(t);\n      (null == e || e.isResolved || e.isRejected) && x.delete(t);\n    }\n  }), s.extent = {\n    xmin: c.xmin,\n    ymin: c.ymin,\n    xmax: c.xmax,\n    ymax: c.ymax\n  };\n}\nexport { s as decreaseRefCount, h as deleteBlock, f as deleteRaster, m as getBlock, i as getRasterId, x as putBlock, u as register, a as unregister, g as update };"],
  "mappings": "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",
  "names": ["t", "s", "r", "i", "c", "t", "e", "t", "i", "e", "r", "l", "u", "c", "a", "s", "m", "x", "h", "g", "d", "C"]
}
