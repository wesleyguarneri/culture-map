{
  "version": 3,
  "sources": ["../../../../../../node_modules/@arcgis/core/layers/graphics/data/StreamFeatureManager.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport t from \"../../../core/CircularArray.js\";\nimport { clamp as e } from \"../../../core/mathUtils.js\";\nconst s = \"__esri_stream_id__\",\n  i = \"__esri_timestamp__\",\n  r = 1e3;\nclass o {\n  constructor(t, e, i, r, o = 128) {\n    this._trackIdToObservations = new Map(), this._idCounter = 0, this._lastPurge = performance.now(), this._addOrUpdated = new Map(), this._removed = [], this._maxAge = 0, this._timeInfo = i, this._purgeOptions = r, this.store = t, this.objectIdField = e, this.purgeInterval = o, this._useGeneratedIds = this.objectIdField === s;\n  }\n  removeById(t) {\n    this._removed.push(t);\n  }\n  removeByTrackId(t) {\n    const e = this._trackIdToObservations.get(t);\n    if (e) for (const s of e.entries) this._removed.push(s);\n  }\n  add(s) {\n    if (this._useGeneratedIds) {\n      const t = this._nextId();\n      s.attributes[this.objectIdField] = t, s.objectId = t;\n    } else s.objectId = s.attributes[this.objectIdField];\n    const i = s.objectId;\n    if (this._addOrUpdated.set(i, s), this._maxAge = Math.max(this._maxAge, s.attributes[this._timeInfo.startTimeField]), !this._timeInfo.trackIdField) return null == this._trackIdLessObservations && (this._trackIdLessObservations = new t(1e5)), void this._trackIdLessObservations.enqueue(i);\n    const o = s.attributes[this._timeInfo.trackIdField];\n    if (!this._trackIdToObservations.has(o)) {\n      const s = null != this._purgeOptions?.maxObservations ? this._purgeOptions.maxObservations : r,\n        i = e(s, 0, r);\n      this._trackIdToObservations.set(o, new t(i));\n    }\n    const d = this._trackIdToObservations.get(o),\n      a = d?.enqueue(i);\n    null != a && (this._addOrUpdated.has(a) ? this._addOrUpdated.delete(a) : this._removed.push(a));\n  }\n  checkForUpdates() {\n    const t = this._getToAdd(),\n      e = this._getToRemove(),\n      s = performance.now();\n    s - this._lastPurge >= this.purgeInterval && (this._purge(s), this._lastPurge = s);\n    const r = [];\n    if (null != e) for (const i of e) {\n      const t = this.store.removeById(i);\n      null != t && r.push(t);\n    }\n    const o = [];\n    if (null != t) {\n      const r = new Set(e ?? []);\n      for (const e of t) r.has(e.objectId) || (e.attributes[i] = s, this.store.add(e), o.push(e));\n    }\n    return !(!o.length && !r?.length) && (this.store.update(o, r), !0);\n  }\n  _getToAdd() {\n    if (!this._addOrUpdated.size) return null;\n    const t = new Array(this._addOrUpdated.size);\n    let e = 0;\n    return this._addOrUpdated.forEach(s => t[e++] = s), this._addOrUpdated.clear(), t;\n  }\n  _getToRemove() {\n    const t = this._removed;\n    return this._removed.length ? (this._removed = [], t) : null;\n  }\n  _nextId() {\n    const t = this._idCounter;\n    return this._idCounter = (this._idCounter + 1) % 4294967294 + 1, t;\n  }\n  _purge(t) {\n    const e = this._purgeOptions;\n    null != e && (this._purgeSomeByDisplayCount(e), this._purgeByAge(e), this._purgeByAgeReceived(t, e), this._purgeTracks());\n  }\n  _purgeSomeByDisplayCount(t) {\n    if (!t.displayCount) return;\n    let e = this.store.size;\n    if (e > t.displayCount) {\n      if (this._timeInfo.trackIdField) for (const s of this._trackIdToObservations.values()) if (e > t.displayCount && s.size) {\n        const t = s.dequeue();\n        this._removed.push(t), e--;\n      }\n      if (null != this._trackIdLessObservations) {\n        let s = e - t.displayCount;\n        for (; s-- > 0;) {\n          const t = this._trackIdLessObservations.dequeue();\n          null != t && this._removed.push(t);\n        }\n      }\n    }\n  }\n  _purgeByAge(t) {\n    const e = this._timeInfo?.startTimeField;\n    if (!t.age || !e) return;\n    const s = 60 * t.age * 1e3,\n      i = this._maxAge - s;\n    this.store.forEach(t => {\n      t.attributes[e] < i && this._removed.push(t.objectId);\n    });\n  }\n  _purgeByAgeReceived(t, e) {\n    if (!e.ageReceived) return;\n    const s = t - 60 * e.ageReceived * 1e3;\n    this.store.forEach(t => {\n      t.attributes[i] < s && this._removed.push(t.objectId);\n    });\n  }\n  _purgeTracks() {\n    this._trackIdToObservations.forEach((t, e) => {\n      0 === t.size && this._trackIdToObservations.delete(e);\n    });\n  }\n}\nexport { o as StreamFeatureManager, s as defaultStreamIdField, i as esriTimestamp };"],
  "mappings": "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",
  "names": ["t", "e", "i", "r", "o", "s"]
}
