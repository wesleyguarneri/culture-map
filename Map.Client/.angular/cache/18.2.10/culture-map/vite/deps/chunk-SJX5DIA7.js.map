{
  "version": 3,
  "sources": ["../../../../../../node_modules/@arcgis/core/layers/mixins/PortalLayer.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.30/esri/copyright.txt for details.\n*/\nimport { _ as t } from \"../../chunks/tslib.es6.js\";\nimport e from \"../../config.js\";\nimport { id as r } from \"../../kernel.js\";\nimport s from \"../../request.js\";\nimport { result as i } from \"../../core/asyncUtils.js\";\nimport o from \"../../core/Error.js\";\nimport a from \"../../core/Logger.js\";\nimport { destroyMaybe as l } from \"../../core/maybe.js\";\nimport { throwIfAborted as n, isAbortError as p, throwIfAbortError as u } from \"../../core/promiseUtils.js\";\nimport { hasSameCanonicalPortal as c, normalize as d, hasSamePortal as m } from \"../../core/urlUtils.js\";\nimport { property as h } from \"../../core/accessorSupport/decorators/property.js\";\nimport \"../../core/has.js\";\nimport \"../../core/RandomLCG.js\";\nimport { reader as f } from \"../../core/accessorSupport/decorators/reader.js\";\nimport { subclass as g } from \"../../core/accessorSupport/decorators/subclass.js\";\nimport { writer as y } from \"../../core/accessorSupport/decorators/writer.js\";\nimport { getOwningPortalUrl as I } from \"../support/layerUtils.js\";\nimport v from \"../../portal/Portal.js\";\nimport P from \"../../portal/PortalItem.js\";\nimport w from \"../../portal/PortalUser.js\";\nimport { getUserPrivileges as U } from \"../../portal/support/portalItemUtils.js\";\nconst j = j => {\n    let _ = class extends j {\n      constructor() {\n        super(...arguments), this.resourceReferences = {\n          portalItem: null,\n          paths: []\n        }, this.userHasEditingPrivileges = !0, this.userHasFullEditingPrivileges = !1, this.userHasUpdateItemPrivileges = !1;\n      }\n      destroy() {\n        this.portalItem = l(this.portalItem), this.resourceReferences.portalItem = null, this.resourceReferences.paths.length = 0;\n      }\n      set portalItem(t) {\n        t !== this._get(\"portalItem\") && (this.removeOrigin(\"portal-item\"), this._set(\"portalItem\", t));\n      }\n      readPortalItem(t, e, r) {\n        if (e.itemId) return new P({\n          id: e.itemId,\n          portal: r?.portal\n        });\n      }\n      writePortalItem(t, e) {\n        t?.id && (e.itemId = t.id);\n      }\n      async loadFromPortal(t, e) {\n        if (this.portalItem?.id) try {\n          const {\n            load: r\n          } = await import(\"../../portal/support/layersLoader.js\");\n          return n(e), await r({\n            instance: this,\n            supportedTypes: t.supportedTypes,\n            validateItem: t.validateItem,\n            supportsData: t.supportsData,\n            layerModuleTypeMap: t.layerModuleTypeMap\n          }, e);\n        } catch (r) {\n          throw p(r) || a.getLogger(this).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\\n  ${r}`), r;\n        }\n      }\n      async finishLoadEditablePortalLayer(t) {\n        this._set(\"userHasEditingPrivileges\", await this._fetchUserHasEditingPrivileges(t).catch(t => (u(t), !0)));\n      }\n      async setUserPrivileges(t, r) {\n        if (!e.userPrivilegesApplied) return this.finishLoadEditablePortalLayer(r);\n        if (this.url) try {\n          const {\n            features: {\n              edit: e,\n              fullEdit: s\n            },\n            content: {\n              updateItem: i\n            }\n          } = await this._fetchUserPrivileges(t, r);\n          this._set(\"userHasEditingPrivileges\", e), this._set(\"userHasFullEditingPrivileges\", s), this._set(\"userHasUpdateItemPrivileges\", i);\n        } catch (s) {\n          u(s);\n        }\n      }\n      async _fetchUserPrivileges(t, e) {\n        let s = this.portalItem;\n        if (!t || !s || !s.loaded || s.sourceUrl) return this._fetchFallbackUserPrivileges(e);\n        const i = t === s.id;\n        if (i && s.portal.user) return U(s);\n        let o, a;\n        if (i) o = s.portal.url;else try {\n          o = await I(this.url, e);\n        } catch (d) {\n          u(d);\n        }\n        if (!o || !c(o, s.portal.url)) return this._fetchFallbackUserPrivileges(e);\n        try {\n          const t = null != e ? e.signal : null;\n          a = await r?.getCredential(`${o}/sharing`, {\n            prompt: !1,\n            signal: t\n          });\n        } catch (d) {\n          u(d);\n        }\n        const l = !0,\n          n = !1,\n          p = !1;\n        if (!a) return {\n          features: {\n            edit: l,\n            fullEdit: n\n          },\n          content: {\n            updateItem: p\n          }\n        };\n        try {\n          if (i ? await s.reload() : (s = new P({\n            id: t,\n            portal: {\n              url: o\n            }\n          }), await s.load(e)), s.portal.user) return U(s);\n        } catch (d) {\n          u(d);\n        }\n        return {\n          features: {\n            edit: l,\n            fullEdit: n\n          },\n          content: {\n            updateItem: p\n          }\n        };\n      }\n      async _fetchFallbackUserPrivileges(t) {\n        let e = !0;\n        try {\n          e = await this._fetchUserHasEditingPrivileges(t);\n        } catch (r) {\n          u(r);\n        }\n        return {\n          features: {\n            edit: e,\n            fullEdit: !1\n          },\n          content: {\n            updateItem: !1\n          }\n        };\n      }\n      async _fetchUserHasEditingPrivileges(t) {\n        const e = this.url ? r?.findCredential(this.url) : null;\n        if (!e) return !0;\n        const s = E.credential === e ? E.user : await this._fetchEditingUser(t);\n        return E.credential = e, E.user = s, null == s?.privileges || s.privileges.includes(\"features:user:edit\");\n      }\n      async _fetchEditingUser(t) {\n        const e = this.portalItem?.portal?.user;\n        if (e) return e;\n        const o = r?.findServerInfo(this.url ?? \"\");\n        if (!o?.owningSystemUrl) return null;\n        const a = `${o.owningSystemUrl}/sharing/rest`,\n          l = v.getDefault();\n        if (l && l.loaded && d(l.restUrl) === d(a)) return l.user;\n        const n = `${a}/community/self`,\n          p = null != t ? t.signal : null,\n          u = await i(s(n, {\n            authMode: \"no-prompt\",\n            query: {\n              f: \"json\"\n            },\n            signal: p\n          }));\n        return u.ok ? w.fromJSON(u.value.data) : null;\n      }\n      read(t, e) {\n        e && (e.layer = this), super.read(t, e);\n      }\n      write(t, e) {\n        const r = e?.portal,\n          s = this.portalItem?.id && (this.portalItem.portal || v.getDefault());\n        return r && s && !m(s.restUrl, r.restUrl) ? (e.messages && e.messages.push(new o(\"layer:cross-portal\", `The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`, {\n          layer: this\n        })), null) : super.write(t, {\n          ...e,\n          layer: this\n        });\n      }\n    };\n    return t([h({\n      type: P\n    })], _.prototype, \"portalItem\", null), t([f(\"web-document\", \"portalItem\", [\"itemId\"])], _.prototype, \"readPortalItem\", null), t([y(\"web-document\", \"portalItem\", {\n      itemId: {\n        type: String\n      }\n    })], _.prototype, \"writePortalItem\", null), t([h({\n      clonable: !1\n    })], _.prototype, \"resourceReferences\", void 0), t([h({\n      type: Boolean,\n      readOnly: !0\n    })], _.prototype, \"userHasEditingPrivileges\", void 0), t([h({\n      type: Boolean,\n      readOnly: !0\n    })], _.prototype, \"userHasFullEditingPrivileges\", void 0), t([h({\n      type: Boolean,\n      readOnly: !0\n    })], _.prototype, \"userHasUpdateItemPrivileges\", void 0), _ = t([g(\"esri.layers.mixins.PortalLayer\")], _), _;\n  },\n  E = {\n    credential: null,\n    user: null\n  };\nexport { j as PortalLayer };"],
  "mappings": "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",
  "names": ["j", "_", "t", "e", "r", "s", "o", "a", "n", "p", "u"]
}
