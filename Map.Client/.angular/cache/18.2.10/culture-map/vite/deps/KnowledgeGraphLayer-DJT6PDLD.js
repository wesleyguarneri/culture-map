import {
  E,
  M,
  T,
  ae
} from "./chunk-M27RJZHW.js";
import "./chunk-AX5IV6EC.js";
import {
  R
} from "./chunk-EMTRPOGO.js";
import "./chunk-CI7E4T7M.js";
import "./chunk-7PCL3GUC.js";
import "./chunk-ROATEOHC.js";
import "./chunk-BIWDYV6F.js";
import "./chunk-4MXR7W7N.js";
import "./chunk-6UYQMUGI.js";
import "./chunk-D3XZUGMN.js";
import "./chunk-YFQ32AQX.js";
import "./chunk-L4AYSXFJ.js";
import "./chunk-POQ3T5EH.js";
import "./chunk-LPEFONL3.js";
import "./chunk-SSMSHZ2C.js";
import "./chunk-DM4WHMQY.js";
import "./chunk-DON3YPGT.js";
import "./chunk-C7NRYPDG.js";
import "./chunk-Z3GMSC63.js";
import "./chunk-F35MWZH7.js";
import "./chunk-ED7UGR2X.js";
import "./chunk-YA5CTHMT.js";
import "./chunk-4QBFFLOC.js";
import "./chunk-O437BSYE.js";
import "./chunk-YZNT6QWD.js";
import "./chunk-YVOGHYE3.js";
import "./chunk-IBOZJLSO.js";
import {
  l as l2
} from "./chunk-DSMB46HB.js";
import "./chunk-USSQX44O.js";
import "./chunk-OTI4DGZ5.js";
import "./chunk-KQDYTHCF.js";
import "./chunk-TR6FCWXY.js";
import "./chunk-TROPJVOL.js";
import "./chunk-JKHDI77M.js";
import "./chunk-3AY5EJVP.js";
import "./chunk-XQCKIDQO.js";
import "./chunk-BNK4CEA6.js";
import "./chunk-6LDLRQX4.js";
import "./chunk-Z4YAQ5JI.js";
import "./chunk-K2XCQKCC.js";
import "./chunk-AJS4B62I.js";
import "./chunk-S5EXT7FA.js";
import {
  e as e3
} from "./chunk-73Y7XDLH.js";
import "./chunk-YFOAET4H.js";
import "./chunk-5U4TBXYS.js";
import "./chunk-6WG22V46.js";
import "./chunk-OOGIXDXG.js";
import "./chunk-JFYQTYD3.js";
import "./chunk-KDJZAYOF.js";
import "./chunk-5453A3C5.js";
import "./chunk-HCFDI7IX.js";
import "./chunk-AQJS6F3O.js";
import "./chunk-WUB6LJVL.js";
import "./chunk-QXSES7JX.js";
import "./chunk-5YIMTGEC.js";
import "./chunk-YPU2P4KO.js";
import "./chunk-UFVMJL32.js";
import "./chunk-2SMFPIRI.js";
import "./chunk-2GMKFOCL.js";
import "./chunk-ZR5BOILP.js";
import "./chunk-QCBC3RJX.js";
import "./chunk-6XGV55XZ.js";
import "./chunk-HOH445RO.js";
import "./chunk-63QCTVYB.js";
import "./chunk-U74WRHVJ.js";
import "./chunk-TCPN7AEH.js";
import "./chunk-TRSGUVSM.js";
import "./chunk-U3MA63JX.js";
import "./chunk-WYKKCLBI.js";
import "./chunk-PFMGJTQM.js";
import "./chunk-Q7SRMLJZ.js";
import "./chunk-PQ4T66BG.js";
import "./chunk-SWPHGZYB.js";
import "./chunk-DWASPXVI.js";
import "./chunk-TNWXOQKO.js";
import "./chunk-MAO5BVLA.js";
import "./chunk-T2S5VXNP.js";
import "./chunk-4U5GUJRA.js";
import "./chunk-7KRERHHR.js";
import "./chunk-T4AP6CTC.js";
import "./chunk-HD65DNIO.js";
import "./chunk-4KWLMXIA.js";
import "./chunk-BIUXKPKA.js";
import "./chunk-N6TJI25E.js";
import "./chunk-634JLXD4.js";
import "./chunk-Y3EDGYWG.js";
import "./chunk-UF6JOUSJ.js";
import "./chunk-T5JGQSO3.js";
import "./chunk-CIW3KHOW.js";
import "./chunk-J55F4AC2.js";
import "./chunk-IQLBZKUD.js";
import "./chunk-7MZZCQ64.js";
import "./chunk-LNRZHZOQ.js";
import "./chunk-DI6VABAK.js";
import "./chunk-5EBAJR7X.js";
import "./chunk-5JA2JHV3.js";
import "./chunk-FUKSTKFU.js";
import "./chunk-MIQZ6UDY.js";
import "./chunk-JOJZ6YC5.js";
import "./chunk-L4TOCXR5.js";
import "./chunk-IMVP5ADD.js";
import "./chunk-H7WPOTQH.js";
import "./chunk-7WP676SE.js";
import {
  j
} from "./chunk-SJX5DIA7.js";
import "./chunk-SGSUM5YO.js";
import "./chunk-SG5TCCCK.js";
import "./chunk-6A7CWJED.js";
import "./chunk-LFKEQKEA.js";
import "./chunk-DUTZNK67.js";
import "./chunk-IN6BQCWS.js";
import "./chunk-CRNUMTSV.js";
import "./chunk-JM7HAEY6.js";
import {
  f as f2
} from "./chunk-DOK4SACJ.js";
import {
  l
} from "./chunk-OUKUASAF.js";
import "./chunk-V5RMUGJJ.js";
import "./chunk-D2NB6D6N.js";
import {
  t as t2
} from "./chunk-UWJIHV6Q.js";
import {
  b
} from "./chunk-ZUSCOMQM.js";
import {
  p as p2
} from "./chunk-DSEUCBVP.js";
import "./chunk-UPDWQH75.js";
import {
  S
} from "./chunk-RXWBJSJ5.js";
import {
  f
} from "./chunk-M2NS3MSU.js";
import "./chunk-HMNBB7ED.js";
import "./chunk-3RRMLFFN.js";
import "./chunk-DR5TVNEL.js";
import "./chunk-HT2T6PUB.js";
import "./chunk-K64AAM77.js";
import "./chunk-6EUVKE22.js";
import "./chunk-A3NNJ7XA.js";
import "./chunk-OKJHJ3CY.js";
import "./chunk-XTVPEVHA.js";
import "./chunk-DTUSTSEJ.js";
import "./chunk-JCWFGRHQ.js";
import "./chunk-JILEJ6R2.js";
import "./chunk-GAW5JHG4.js";
import "./chunk-OEKKQXBD.js";
import "./chunk-S3IO7V4Q.js";
import "./chunk-DZALMCYL.js";
import "./chunk-K226GFDN.js";
import "./chunk-4ZZRP4MA.js";
import "./chunk-7ZJ6P7J7.js";
import "./chunk-FPFZQCEQ.js";
import {
  n as n3
} from "./chunk-5I6J67HP.js";
import "./chunk-YVULORT6.js";
import "./chunk-PB33BAI3.js";
import "./chunk-CVB43GGP.js";
import "./chunk-XWXBNAOW.js";
import "./chunk-GWC3DAGP.js";
import "./chunk-EODIWR2E.js";
import "./chunk-LLDOZWVV.js";
import "./chunk-FYAEQPUY.js";
import "./chunk-7XMEZQ34.js";
import "./chunk-BDM2D6IC.js";
import {
  m,
  p
} from "./chunk-U2ZVAEKG.js";
import "./chunk-EDSMXTFO.js";
import "./chunk-MNLT652N.js";
import "./chunk-OGZAGPIO.js";
import "./chunk-HJJIIYFF.js";
import "./chunk-7RMVJCDW.js";
import "./chunk-T6GCUITX.js";
import "./chunk-TUIGM7TV.js";
import "./chunk-IHVSZYZS.js";
import "./chunk-6CA6K3O7.js";
import "./chunk-NYQ5CYNR.js";
import "./chunk-O7UDKFOW.js";
import "./chunk-TKPMIAIW.js";
import {
  o
} from "./chunk-NQOJNTB3.js";
import {
  r as r2
} from "./chunk-MFOQYQFG.js";
import "./chunk-NKCPFCP3.js";
import "./chunk-3ZXOUEQG.js";
import "./chunk-AXVPJBVW.js";
import "./chunk-OXEPWRM7.js";
import "./chunk-POILQGXA.js";
import "./chunk-JJS7PR2U.js";
import "./chunk-L5YS4GSA.js";
import "./chunk-PRREDSOB.js";
import "./chunk-V5C6HSAM.js";
import {
  V as V2,
  Y
} from "./chunk-SYATLP3H.js";
import "./chunk-V6AMQYXE.js";
import "./chunk-6WHTZNUH.js";
import {
  V
} from "./chunk-EITGQLII.js";
import "./chunk-TIVJXVMN.js";
import "./chunk-XNUH25NY.js";
import "./chunk-WGAPNV7F.js";
import "./chunk-BXQGM56A.js";
import {
  e as e2
} from "./chunk-4Z5SGKRM.js";
import {
  e,
  n2,
  t3 as t
} from "./chunk-ANKOCGE2.js";
import {
  y
} from "./chunk-7CJXZOFG.js";
import "./chunk-IRGZKO7V.js";
import "./chunk-5SELS7VU.js";
import {
  a3 as a2,
  r2 as r
} from "./chunk-DDYVXG4F.js";
import "./chunk-ANP42J2U.js";
import {
  a
} from "./chunk-HJY2YILU.js";
import "./chunk-7DA6A5LD.js";
import "./chunk-2MMLMOWS.js";
import "./chunk-4323ZVPF.js";
import {
  n2 as n,
  s2 as s
} from "./chunk-WYIDUUN2.js";
import "./chunk-DXLOWWK7.js";
import {
  __async
} from "./chunk-JWIQHGQB.js";

// ../../../node_modules/@arcgis/core/layers/KnowledgeGraphLayer.js
var E2 = class extends l(t2(f2(l2(b(j(S(e3(f)))))))) {
  constructor(e4) {
    super(e4), this._graphTypeLookup = /* @__PURE__ */ new Map(), this._namedTypesModified = false, this.dataManager = null, this.definitionSetMap = null, this.knowledgeGraph = null, this.layers = new (V.ofType(ae))(), this.memberEntityTypes = null, this.memberRelationshipTypes = null, this.operationalLayerType = "KnowledgeGraphLayer", this.sublayerIdsCache = /* @__PURE__ */ new Map(), this.tables = new (V.ofType(ae))(), this.type = "knowledge-graph", this.url = null;
  }
  load(e4) {
    return this.addResolvingPromise(this._doLoad(e4)), Promise.resolve(this);
  }
  _doLoad(e4) {
    return __async(this, null, function* () {
      try {
        yield this.loadFromPortal({
          supportedTypes: ["Knowledge Graph Layer"]
        }, e4);
      } catch (t3) {
        a(t3);
      }
      yield this._fetchMetadata(), yield this._initializeLayerProperties(), this.loadLayerAssumingLocalCache();
    });
  }
  _fetchMetadata() {
    return __async(this, null, function* () {
      if (!this.url) throw new s("knowledge-graph:missing-url", "KnowledgeGraphLayer must be created with a url");
      const e4 = yield R(this.url);
      this.knowledgeGraph = e4, this._forEachGraphType((e5) => {
        e5.name && this._graphTypeLookup.set(e5.name, e5);
      });
    });
  }
  _initializeLayerProperties() {
    return __async(this, null, function* () {
      this.originIdOf("inclusionModeDefinition") === e.USER ? this._validateInclusionModeDefinition() : yield this._initializeInclusionModeDefinition(), this._setMemberTypes(), this.dataManager = new M({
        knowledgeGraph: this.knowledgeGraph,
        inclusionModeDefinition: this.inclusionModeDefinition
      });
    });
  }
  _initializeInclusionModeDefinition() {
    return __async(this, null, function* () {
      const e4 = this.definitionSetMap ? yield T(this.definitionSetMap, true) : {
        generateAllSublayers: true,
        namedTypeDefinitions: /* @__PURE__ */ new Map()
      };
      [...this.layers.toArray(), ...this.tables.toArray()].forEach((t3) => {
        const i = this._graphTypeLookup.get(t3.graphTypeName);
        i && !e4.namedTypeDefinitions.has(i.name) && e4.namedTypeDefinitions.set(i.name, {
          useAllData: true
        });
      }), this.setAtOrigin("inclusionModeDefinition", e4, t(this.originIdOf("definitionSetMap")));
    });
  }
  _validateInclusionModeDefinition() {
    const {
      inclusionModeDefinition: e4
    } = this;
    if (!e4) return;
    const {
      namedTypeDefinitions: t3
    } = e4;
    if (t3?.size > 0) t3.forEach((e5, i) => {
      const s2 = this._graphTypeLookup.get(i);
      if (!s2) return n.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`), void t3.delete(i);
      "relationship" !== s2.type && "entity" !== s2.type && (n.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't properly modeled and will be removed`), t3.delete(i));
    });
    else if (!e4.generateAllSublayers) throw new s("knowledge-graph:composite-layer-constructor", "If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");
  }
  _setMemberTypes() {
    let e4 = [], t3 = [];
    const {
      inclusionModeDefinition: i
    } = this, o2 = i?.namedTypeDefinitions;
    !i || i.generateAllSublayers ? (e4 = this.knowledgeGraph.dataModel?.entityTypes ?? [], t3 = this.knowledgeGraph.dataModel?.relationshipTypes ?? []) : o2 && o2.size > 0 && o2.forEach((i2, o3) => {
      const s2 = this._graphTypeLookup.get(o3);
      switch (s2?.type) {
        case "relationship":
          t3.push(s2);
          break;
        case "entity":
          e4.push(s2);
      }
    }), this.memberEntityTypes = e4, this.memberRelationshipTypes = t3;
  }
  _forEachGraphType(e4) {
    [...this.knowledgeGraph.dataModel?.entityTypes ?? [], ...this.knowledgeGraph.dataModel?.relationshipTypes ?? []].forEach((t3) => {
      e4(t3);
    });
  }
  _refreshNamedTypes() {
    this._namedTypesModified = true;
    for (const e4 of this.layers) e4.emit("refresh", {
      dataChanged: true
    });
    for (const e4 of this.tables) e4.emit("refresh", {
      dataChanged: true
    });
  }
  _handleNewRecords(e4) {
    return __async(this, null, function* () {
      const t3 = [];
      this.dataManager.addToLayer(e4);
      for (const i of e4) this.sublayerIdsCache.has(i.typeName) || (this.sublayerIdsCache.set(i.typeName, /* @__PURE__ */ new Set()), t3.push(i.typeName)), this.sublayerIdsCache.get(i.typeName).add(i.id);
      for (const i of t3) {
        const e5 = this._graphTypeLookup.get(i);
        if (!e5) continue;
        this._addSublayer(e5).title = i, "entity" === e5.type ? this.dataManager.entityTypeNames.add(i) : this.dataManager.relationshipTypeNames.add(i), this.dataManager.sublayerCaches.set(i, /* @__PURE__ */ new Map());
      }
      this._refreshNamedTypes();
    });
  }
  _createSublayers(e4, t3, i) {
    e4.forEach((e5) => {
      const o2 = this._createSublayer(e5);
      i(o2) && t3.push(o2), this._updateSublayerCaches(e5);
    });
  }
  _addSublayer(e4) {
    const t3 = this._createSublayer(e4);
    return t3.geometryType ? this.layers.push(t3) : this.tables.push(t3), t3;
  }
  _createSublayer(e4) {
    return new ae({
      objectType: e4,
      parentCompositeLayer: this,
      graphType: e4.type,
      title: e4.name
    });
  }
  _updateSublayers(e4, t3) {
    t3.forEach((t4) => {
      t4.parentCompositeLayer = this;
      const i = e4.find((e5) => e5.type === t4.graphType && e5.name === t4.graphTypeName);
      i && (t4.objectType = i, t4.read({
        title: i.name
      }, {
        origin: "service"
      }), this._updateSublayerCaches(i));
    });
  }
  _updateSublayerCaches(e4) {
    const t3 = this.dataManager.sublayerCaches;
    t3.has(e4.name) || t3.set(e4.name, /* @__PURE__ */ new Map());
  }
  _saveUrlAsNewResource(e4, t3, i, o2) {
    e4[t3] = "<pending>", i.pendingOperations.push(I(this.inclusionModeDefinition).then((s2) => {
      const r3 = O(o2);
      e4[t3] = r3.itemRelativeUrl, i.toAdd.push({
        resource: r3,
        content: {
          type: "blob",
          blob: s2
        },
        compress: false,
        finish: (e5) => {
          this.definitionSetMap = e5.url;
        }
      });
    }));
  }
  _displaysAllRecords(e4) {
    for (const [, {
      useAllData: t3
    }] of e4.namedTypeDefinitions) if (!t3) return false;
    return true;
  }
  readDefinitionSetMap(e4, t3, i) {
    return p(e4, i);
  }
  writeDefinitionSetMap(e4, t3, i, o2) {
    const s2 = o2?.portalItem, r3 = o2?.resources, a3 = n2(o2?.origin);
    if (!s2 || !r3 || null == a3) return void (e4 && (t3[i] = m(e4, o2)));
    const {
      inclusionModeDefinition: p3
    } = this;
    if (!p3 || this._displaysAllRecords(p3)) return void (this.definitionSetMap = null);
    const l3 = this.originIdOf("inclusionModeDefinition");
    if (l3 === e.USER || this._namedTypesModified || a3 < l3) this._saveUrlAsNewResource(t3, i, r3, s2);
    else if (a3 === l3 && e4) {
      const a4 = m(e4, o2);
      Y(a4) ? this._saveUrlAsNewResource(t3, i, r3, s2) : t3[i] = a4;
    }
  }
  set inclusionModeDefinition(e4) {
    "loaded" !== this.loadStatus && "failed" !== this.loadStatus ? this._set("inclusionModeDefinition", e4) : n.getLogger(this).error("#inclusionModeDefinition", "inclusionModeDefinition cannot be changed after the layer is loaded.");
  }
  loadLayerAssumingLocalCache() {
    const e4 = [...this.memberEntityTypes, ...this.memberRelationshipTypes];
    this.originIdOf("layers") === e.DEFAULTS ? this._createSublayers(e4, this.layers, (e5) => !!e5.geometryType) : this._updateSublayers(e4, this.layers), this.originIdOf("tables") === e.DEFAULTS ? this._createSublayers(e4, this.tables, (e5) => !e5.geometryType) : this._updateSublayers(e4, this.tables), this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e5, t3) => {
      const i = r(this.sublayerIdsCache, t3, () => /* @__PURE__ */ new Set());
      e5.members?.forEach((e6) => {
        i.add(e6.id);
      });
    });
  }
  addRecords(e4) {
    return __async(this, null, function* () {
      yield this._handleNewRecords(e4);
    });
  }
  removeRecords(e4) {
    return __async(this, null, function* () {
      const t3 = [];
      for (const i of e4) false === this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(i.typeName)?.useAllData && this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(i.typeName)?.members?.has(i.id) && t3.push(i);
      this.dataManager.removeFromLayer(t3);
      for (const i of t3) this.sublayerIdsCache.get(i.typeName)?.delete(i.id);
      return this._refreshNamedTypes(), t3;
    });
  }
};
e2([y()], E2.prototype, "dataManager", void 0), e2([y({
  json: {
    write: {
      ignoreOrigin: true,
      writerEnsuresNonNull: true
    }
  }
})], E2.prototype, "definitionSetMap", void 0), e2([o("definitionSetMap")], E2.prototype, "readDefinitionSetMap", null), e2([r2("definitionSetMap")], E2.prototype, "writeDefinitionSetMap", null), e2([y()], E2.prototype, "inclusionModeDefinition", null), e2([y()], E2.prototype, "knowledgeGraph", void 0), e2([y({
  type: V.ofType(ae),
  json: {
    write: {
      ignoreOrigin: true
    }
  }
})], E2.prototype, "layers", void 0), e2([y()], E2.prototype, "memberEntityTypes", void 0), e2([y()], E2.prototype, "memberRelationshipTypes", void 0), e2([y({
  type: ["KnowledgeGraphLayer"]
})], E2.prototype, "operationalLayerType", void 0), e2([y()], E2.prototype, "sublayerIdsCache", void 0), e2([y({
  type: V.ofType(ae),
  json: {
    write: {
      ignoreOrigin: true
    }
  }
})], E2.prototype, "tables", void 0), e2([y({
  json: {
    read: false
  }
})], E2.prototype, "type", void 0), e2([y(p2)], E2.prototype, "url", void 0), E2 = e2([a2("esri.layers.KnowledgeGraphLayer")], E2);
var R2 = E2;
function I(e4) {
  return __async(this, null, function* () {
    const t3 = yield E(e4);
    return new Blob([t3], {
      type: "application/x-protobuf"
    });
  });
}
function O(e4) {
  const t3 = `definitionSetMap-${n3()}.dat`, i = V2("knowledgeGraphLayer", t3);
  return e4.resourceFromPath(i);
}
export {
  R2 as default
};
//# sourceMappingURL=KnowledgeGraphLayer-DJT6PDLD.js.map
